<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Builder: مسرح جريمة ثلاثي الأبعاد - وضع نماذج GLB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root { --bg:#0f1112; --panel:#131516; --accent:#c59e2b; --muted:#9aa0a6; color-scheme: dark; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#fff}
    #app{display:flex;height:100vh;gap:10px}
    #sidebar{width:360px;background:var(--panel);padding:12px;overflow:auto;border-right:1px solid rgba(255,255,255,0.04)}
    h2{margin:6px 0 12px 0;font-size:18px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], input[type="url"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0c0d0e;color:#fff}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#081217;cursor:pointer;margin-top:8px;font-weight:700}
    .small{background:#222;border-radius:8px;padding:6px 8px;margin-left:6px;font-size:13px;color:var(--muted)}
    .item{background:#0b0c0d;padding:8px;border-radius:8px;margin-top:8px;display:flex;gap:8px;align-items:center}
    .list{margin-top:10px}
    #sceneWrap{flex:1;position:relative}
    #hud{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:gold;z-index:2}
    #controls{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;z-index:2}
    #message{position:absolute;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:8px;z-index:2}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
    .list .row{display:flex;justify-content:space-between;align-items:center}
    .previewSmall{width:60px;height:45px;background:#080808;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#777}
    .selected{outline:2px solid #2ecc71}
    #timer{font-weight:900;color:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <h2>مكتبة العناصر - أضف نموذج GLB</h2>

      <label>اسم العنصر</label>
      <input id="modelName" type="text" placeholder="مثال: سكين (Knife)">

      <label>رابط الملف .glb / .gltf (رابط مباشر)</label>
      <input id="modelUrl" type="url" placeholder="https://.../model.glb">

      <div style="display:flex;gap:8px;">
        <button id="addBtn">➕ أضف إلى القائمة</button>
        <button id="previewBtn" class="btn-ghost">👁 معاينة</button>
      </div>
      <div class="hint">يمكنك إضافة أي رابط glb صالح - سيظهر في القائمة. (أفضل رفع الملفات على GitHub/Glitch/پولي بيزا أو استخدام روابط Raw من GitHub)</div>

      <h2 style="margin-top:18px">قائمة العناصر</h2>
      <div id="library" class="list"></div>

      <h2 style="margin-top:18px">تحريك العنصر / وضعه</h2>
      <div class="hint">اختر عنصرًا من القائمة ثم استخدم الأزرار أو اسحب في المشهد لتحديد موقعه.</div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button id="placeBtn" class="btn-ghost">📍 ضع العنصر أمام الكاميرا</button>
        <button id="deleteBtn" class="btn-ghost">🗑 حذف العنصر</button>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button id="moveUp" class="btn-ghost">↑</button>
        <button id="moveDown" class="btn-ghost">↓</button>
        <button id="moveLeft" class="btn-ghost">←</button>
        <button id="moveRight" class="btn-ghost">→</button>
      </div>

      <h2 style="margin-top:18px">التشغيل والاختبار</h2>
      <label>مدة الاختبار بالثواني</label>
      <input id="duration" type="text" value="120">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="startBtn">▶️ ابدأ الاختبار</button>
        <button id="stopBtn" class="btn-ghost">⏹ إيقاف</button>
      </div>

      <div style="margin-top:12px">
        <strong>نقاط:</strong> <span id="scorePanel">0</span>
      </div>

      <div style="margin-top:14px">
        <strong>نصائح سريعة:</strong>
        <ul style="margin:6px 0 0 18px;color:var(--muted)">
          <li>استخدم موقع <span style="color:#8fbff0">Sketchfab</span> أو <span style="color:#8fbff0">Poly Haven</span> لتحميل GLB.</li>
          <li>أفضل رفع ملفاتك على GitHub ونسخ رابط raw أو استخدام jsDelivr.</li>
          <li>إذا ظهر خطأ CORS عند المعاينة، ارفق الملف في GitHub/GDrive (مفتوح) أو استخدم خدمة استضافة.</li>
        </ul>
      </div>

    </div>

    <div id="sceneWrap">
      <div id="hud">النقاط: <span id="score">0</span></div>
      <div id="controls">
        <div>الوقت: <span id="timer">--:--</span></div>
        <div style="margin-top:8px"><button id="toggleGiz" class="btn-ghost">تفعيل تحريك بالفأرة</button></div>
      </div>
      <div id="message"></div>

      <!-- مشهد A-Frame -->
      <a-scene id="scene" background="color: #111" embedded vr-mode-ui="enabled: false">
        <!-- أرضية وسجاد -->
        <a-plane rotation="-90 0 0" width="10" height="10" color="#2b221f" repeat="4 4"></a-plane>

        <!-- جدران بسيطة -->
        <a-box position="0 1.6 -5" width="10" height="3" depth="0.1" color="#3c2f2f"></a-box>
        <a-box position="-5 1.6 0" width="0.1" height="3" depth="10" color="#3f3333"></a-box>
        <a-box position="5 1.6 0" width="0.1" height="3" depth="10" color="#3f3333"></a-box>

        <!-- إضاءة -->
        <a-entity light="type: ambient; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="2 4 2"></a-entity>

        <!-- كاميرا -->
        <a-entity id="cameraRig" position="0 1.6 3">
          <a-entity camera look-controls wasd-controls></a-entity>
        </a-entity>
      </a-scene>
    </div>
  </div>

<script>
/* ====== بيانات التطبيق ====== */
const libraryEl = document.getElementById('library');
const addBtn = document.getElementById('addBtn');
const previewBtn = document.getElementById('previewBtn');
const modelNameInput = document.getElementById('modelName');
const modelUrlInput = document.getElementById('modelUrl');
const placeBtn = document.getElementById('placeBtn');
const deleteBtn = document.getElementById('deleteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const durationInput = document.getElementById('duration');
const scorePanel = document.getElementById('scorePanel');
const scoreHud = document.getElementById('score');
const message = document.getElementById('message');
const scene = document.getElementById('scene');
const timerText = document.getElementById('timer');
const toggleGiz = document.getElementById('toggleGiz');

let library = [];         // {id, name, url}
let placed = [];          // placed entities {id, name, el}
let selected = null;
let score = 0;
let timerInterval = null;
let timeLeft = 0;
let allowMoveByMouse = false;

/* ====== وظائف إدارة المكتبة ====== */
function renderLibrary(){
  libraryEl.innerHTML = '';
  library.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div style="flex:1">
        <div class="row"><strong>${escapeHtml(item.name)}</strong></div>
        <div style="font-size:12px;color:#8f999f;margin-top:6px">${escapeHtml(item.url)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost" data-id="${item.id}" onclick="previewModel('${item.url}')">معاينة</button>
        <button class="btn-ghost" data-id="${item.id}" onclick="placeModel('${item.id}')">وضع</button>
      </div>
    `;
    libraryEl.appendChild(div);
  });
}

addBtn.addEventListener('click', ()=>{
  const name = modelNameInput.value.trim() || 'Model';
  const url = modelUrlInput.value.trim();
  if(!url){
    alert('ضع رابط glb أو gltf صالح');
    return;
  }
  const id = 'm'+Date.now();
  library.push({id,name,url});
  modelNameInput.value=''; modelUrlInput.value='';
  renderLibrary();
});

/* ====== معاينة (تضع النموذج مؤقتاً في موقع عرض صغير) ====== */
window.previewModel = function(url){
  // نضيف كيان مؤقت في مركز المشهد، ثم نزيله بعد 6 ثواني
  const tempId = 'preview-'+Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', tempId);
  ent.setAttribute('gltf-model', url);
  ent.setAttribute('position', '0 1 -1');
  ent.setAttribute('scale','0.6 0.6 0.6');
  scene.appendChild(ent);
  message.textContent = 'معاينة: تحميل النموذج...';
  setTimeout(()=>{ message.textContent=''; try{ scene.removeChild(ent);}catch(e){} },6000);
}

/* ====== وضع نموذج أمام الكاميرا ====== */
window.placeModel = function(libId){
  const lib = library.find(l=>l.id===libId);
  if(!lib) return;
  const ent = document.createElement('a-entity');
  const pid = 'p'+Date.now();
  ent.setAttribute('id', pid);
  ent.setAttribute('gltf-model', lib.url);
  // نضع النموذج أمام الكاميرا بمسافة ثابتة
  const cam = document.querySelector('[camera]').parentElement;
  const camPos = cam.getAttribute('position');
  // نضعه أمام بمقدار 1.5 متر
  ent.setAttribute('position', `${camPos.x} ${camPos.y-0.5} ${camPos.z-1.5}`);
  ent.setAttribute('scale', '0.7 0.7 0.7');
  ent.setAttribute('class', 'placed clickable');
  // نجعل كل نموذج قابل لأن يكون دليل evidence افتراضيً
  ent.setAttribute('data-evidence','true');
  scene.appendChild(ent);
  placed.push({id:pid,name:lib.name,el:ent});
  selectPlaced(pid);
}

/* ====== اختيار عنصر موضوع (select) ====== */
function selectPlaced(id){
  // نعلم الكيان المختار بحد بصري
  selected = placed.find(p=>p.id===id);
  // إزالة تمييز من الجميع
  placed.forEach(p=>{ p.el.classList.remove('selected'); });
  if(selected){
    selected.el.classList.add('selected');
  }
}

/* حذف العنصر المختار */
deleteBtn.addEventListener('click', ()=>{
  if(!selected) return alert('اختر عنصرًا موضوعًا أولاً من القائمة الجانبية أو اضغط على العنصر في المشهد.');
  try{ scene.removeChild(selected.el); }catch(e){}
  placed = placed.filter(p=>p.id!==selected.id);
  selected=null;
});

/* وضع العنصر أمام الكاميرا بزر منفصل */
placeBtn.addEventListener('click', ()=>{
  // نستخدم آخر عنصر في المكتبة لوضعه كمثال سريع
  if(library.length===0) return alert('أضف نموذجًا أولاً إلى المكتبة.');
  placeModel(library[library.length-1].id);
});

/* ====== تحريك العنصر بإحداثيات بسيطة (مربعات 0.1m) ====== */
document.getElementById('moveUp').addEventListener('click', ()=>moveSelected(0,0,-0.1));
document.getElementById('moveDown').addEventListener('click', ()=>moveSelected(0,0,0.1));
document.getElementById('moveLeft').addEventListener('click', ()=>moveSelected(-0.1,0,0));
document.getElementById('moveRight').addEventListener('click', ()=>moveSelected(0.1,0,0));

function moveSelected(dx,dy,dz){
  if(!selected) return alert('اختر عنصرًا موضوعًا أولا');
  const pos = selected.el.getAttribute('position');
  selected.el.setAttribute('position', {x: pos.x+dx, y: pos.y+dy, z: pos.z+dz});
}

/* ====== تفعيل سحب بالماوس (بسيط): عند تفعيل، النقر على عنصر يجعله يتحرك مع الماوس */
toggleGiz.addEventListener('click', ()=>{
  allowMoveByMouse = !allowMoveByMouse;
  toggleGiz.textContent = allowMoveByMouse ? 'إيقاف تحريك بالفأرة' : 'تفعيل تحريك بالفأرة';
});

/* نسمع للنقر على الكيانات الموضوعة لاختيارها أو جمع الدليل أثناء الاختبار */
scene.addEventListener('click', (ev)=>{
  // إذا تم النقر على كائن glTF فسيتضمن ev.target.closestEntity
  const target = ev.target;
  // أي كيان موضوع (placed) يمكن اختياره
  const ent = target.closest ? target.closest('a-entity') : null;
  if(!ent) return;
  // إذا يسمح التحريك بالفأرة ونختار عنصرًا للتعديل
  const pid = ent.getAttribute('id');
  const placedItem = placed.find(p=>p.id===pid);
  if(placedItem){
    selectPlaced(pid);
    if(allowMoveByMouse){
      // وضع عنصر أمام الكاميرا عند النقر كطريقة سريعة للنقل (بساطة)
      const cam = document.querySelector('[camera]').parentElement;
      const camPos = cam.getAttribute('position');
      ent.setAttribute('position', `${camPos.x} ${camPos.y-0.8} ${camPos.z-1.2}`);
    }
  }
});

/* ====== نظام البدء والتوقيت وجمع الأدلة ====== */
startBtn.addEventListener('click', ()=>{
  // نضع كل placed entities كدلائل قابلة للجمع (فترة الاختبار)
  if(placed.length===0) return alert('ضع عناصر في الغرفة أولاً');
  score = 0; updateScore();
  timeLeft = parseInt(durationInput.value) || 120;
  updateTimerDisplay();
  // اضف صنف evidence لكل عنصر حتى يكون قابلًا للنقر لجمعه
  placed.forEach(p=> p.el.setAttribute('data-evidence','true'));
  // نبدأ العد
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      endRound();
    }
  },1000);
  message.textContent = '⏳ الاختبار بدأ! حاول جمع الأدلة بالنقر على العناصر.';
});

stopBtn.addEventListener('click', ()=>{ if(timerInterval) clearInterval(timerInterval); message.textContent='⏹ توقف.'; });

function updateTimerDisplay(){
  const mm = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const ss = (timeLeft%60).toString().padStart(2,'0');
  timerText.textContent = `${mm}:${ss}`;
}

/* حدث جمع الدلائل: أثناء الاختبار، النقر على عنصر موضوع يجمعه ويزيد النقاط */
scene.addEventListener('click', (ev)=>{
  if(timeLeft<=0) return;
  const el = ev.target;
  // العنصر المؤهل: يجب أن يكون a-entity يحمل data-evidence="true"
  const ent = el.closest ? el.closest('a-entity') : null;
  if(!ent) return;
  if(ent.getAttribute('data-evidence') === 'true'){
    // نجمع الدليل
    ent.setAttribute('data-evidence','collected');
    // مؤثر بصري بسيط: تصغير وتحويل اللون
    try{
      ent.setAttribute('animation','property: scale; to: 0.4 0.4 0.4; dur:400');
      ent.setAttribute('material','color','#00ff88');
    }catch(e){}
    score += 10;
    updateScore();
    message.textContent = `✅ جمع الدليل: ${ent.getAttribute('id') || 'عنصر'}`;
    setTimeout(()=>message.textContent='',2000);
  }
});

function updateScore(){ scorePanel.textContent = score; scoreHud.textContent = score; }

function endRound(){
  message.textContent = `⏱ انتهى الوقت! مجموع نقاطك: ${score}`;
  // إلغاء قدرة الجمع
  placed.forEach(p=> p.el.setAttribute('data-evidence','false'));
}

/* ====== مساعدة: تفريغ مثال بعناصر اختبار جاهزة (روابط ثابتة للاختبار) ====== */
(function seedExamples(){
  const examples = [
    {name:'زجاجة تجربة (اختبار)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/WaterBottle/glTF/WaterBottle.gltf'},
    {name:'افوكادو (اختبار حجم/مواد)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Avocado/glTF/Avocado.gltf'},
    {name:'Duck (موديل اختبار)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Duck/glTF/Duck.gltf'}
  ];
  examples.forEach(x=> library.push({id:'ex'+Math.random().toString(36).slice(2), name:x.name, url:x.url}));
  renderLibrary();
})();

/* ====== Helpers ====== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

</script>
</body>
</html>
