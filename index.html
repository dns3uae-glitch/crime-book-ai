<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>AI Crime Scene â€“ Elite Investigator Edition (v9-fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
:root{--gold:#d4af37;--dark:#0a0c0f;--glass:#0f1317cc}
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:var(--dark);font-family:"Tajawal",system-ui,Arial;color:#fff}
a-scene{width:100%;height:100vh;z-index:1}

/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
#overlayStart{
  position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(700px 420px at 50% 40%, rgba(212,175,55,.15), rgba(0,0,0,.8));
  z-index:12000;text-align:center;color:var(--gold);font-size:22px
}
/* Ù…Ù‡Ù…: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø± (Ù„Ø§ ØªÙ…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±) */
#overlayStart, #overlayStart *{ pointer-events:auto !important; }

#overlayStart button{
  margin-top:20px;padding:10px 24px;border:none;border-radius:12px;cursor:pointer;
  background:linear-gradient(90deg,var(--gold),#b78f2a);color:#000;font-weight:800;font-size:18px;
  box-shadow:0 0 14px rgba(212,175,55,.5); transition:transform .18s ease, box-shadow .18s ease, filter .2s ease
}
/* ÙˆÙ…ÙŠØ¶ Ø°Ù‡Ø¨ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
#overlayStart button:hover{ box-shadow:0 0 26px rgba(212,175,55,.85); filter:brightness(1.05) }
#overlayStart button:active{ transform:scale(.96) }

/* HUD */
#hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 12px;font-weight:800;z-index:11000;display:flex;gap:10px;align-items:center}
#time{color:#d4af37}
#status{color:#cfe1ff}
#score{color:#39d98a}

/* Ø·Ø¨Ù‚Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
#uiLayer{position:fixed;inset:0;z-index:10000;pointer-events:none}
#btnOpen{position:absolute;top:20px;right:20px;pointer-events:auto;width:56px;height:56px;border:none;border-radius:50%;cursor:pointer;background:radial-gradient(circle at 35% 30%, var(--gold), #b78f2a);color:#000;font-weight:900;font-size:22px;box-shadow:0 0 12px rgba(212,175,55,.6)}

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
#sidebar{position:absolute;top:0;right:0;width:400px;height:100%;background:var(--glass);backdrop-filter:blur(14px);border-left:1px solid rgba(255,255,255,.12);padding:14px;overflow:auto;transition:right .45s ease;pointer-events:auto;z-index:10001}
#sidebar.hidden{right:-420px}
#sidebarHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#btnClose{pointer-events:auto;border:none;background:transparent;color:#fff;font-size:20px;cursor:pointer}
h2{color:var(--gold);margin:12px 0 8px}
.btn{background:linear-gradient(90deg,var(--gold),#b78f2a);color:#000;font-weight:800;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 0 12px rgba(212,175,55,.4)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#d6dbe3;border-radius:10px;padding:7px 10px;cursor:pointer}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1014;color:#fff}
.library{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.card{background:rgba(255,255,255,.05);border-radius:12px;padding:10px;text-align:center;box-shadow:inset 0 0 14px rgba(212,175,55,.12);transition:.25s;cursor:pointer}
.card:hover{box-shadow:0 0 20px rgba(212,175,55,.28)}
.card .btn{width:100%;margin-top:6px}

/* Ø£Ø³Ù‡Ù… Ø§Ù„ØªØ­ÙƒÙ… */
#controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;flex-wrap:wrap;gap:8px;justify-content:center;z-index:10002;pointer-events:auto}
.ctrl{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;color:#d4af37;box-shadow:0 0 10px rgba(212,175,55,.25)}
.ctrl:hover{background:rgba(212,175,55,.2)}

/* Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© */
#noteModal{position:fixed;inset:0;display:none;place-items:center;z-index:12001;background:radial-gradient(600px 320px at 50% 40%, rgba(212,175,55,.12), rgba(0,0,0,.65))}
.noteCard{width:min(92vw,520px);background:#0b0f13f2;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;box-shadow:0 0 22px rgba(212,175,55,.35)}
.noteCard .row{justify-content:flex-end}

/* Toast */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);padding:10px 14px;border-radius:10px;display:none;z-index:11000}
</style>
</head>
<body>

<!-- Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø§Ù„ØµÙˆØª + Ø²Ø± ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ -->
<div id="overlayStart">
  <div>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©<br>Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</div>
  <!-- Ù…Ù‡Ù…: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø± ÙŠØ¶Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª -->
  <button id="btnStart" onclick="startApp()">Ø§Ø¨Ø¯Ø£</button>
</div>

<!-- HUD -->
<div id="hud">
  â± <span id="time">--:--</span> | <span id="status">Ø¬Ø§Ù‡Ø²</span> | ğŸ§® <span id="score">0</span>
</div>

<!-- Ø§Ù„Ù…Ø´Ù‡Ø¯ -->
<a-scene embedded renderer="antialias:true; colorManagement:true">
  <a-plane id="floor" rotation="-90 0 0" width="30" height="30" color="#1a1f26" class="clickable"></a-plane>
  <a-box class="clickable" position="0 3 -15" width="30" height="6" depth="0.12" color="#0f1317"></a-box>
  <a-box class="clickable" position="0 3 15"  width="30" height="6" depth="0.12" color="#0f1317"></a-box>
  <a-box class="clickable" position="-15 3 0" width="0.12" height="6" depth="30" color="#0f1317"></a-box>
  <a-box class="clickable" position="15 3 0"  width="0.12" height="6" depth="30" color="#0f1317"></a-box>

  <a-entity light="type:ambient; intensity:0.55"></a-entity>
  <a-entity light="type:point; intensity:0.85; color:#d4af37" position="0 3 0"></a-entity>

  <a-entity id="rig" position="0 1.6 6"><a-entity camera look-controls wasd-controls="acceleration:30"></a-entity></a-entity>
  <a-entity id="ray" cursor="rayOrigin:mouse" raycaster="objects:.clickable,.placed,.noteMarker"></a-entity>
</a-scene>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ -->
<div id="uiLayer">
  <button id="btnOpen">â‰¡</button>
  <aside id="sidebar" class="hidden">
    <div id="sidebarHead">
      <div style="color:#d4af37;font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <button id="btnClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© -->
    <h2>ğŸ“¦ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
    <div id="library" class="library"></div>

    <!-- Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø© -->
    <h2>ğŸ§© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø©</h2>
    <select id="placedList" size="6" style="width:100%"></select>
    <div class="row">
      <button class="btn-ghost" id="btnDelete">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±</button>
      <button class="btn-ghost" id="btnReset">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯</button>
    </div>

    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù„Ø© -->
    <h2>âœ…âŒ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
    <div class="row">
      <select id="evidenceSel">
        <option value="none" selected>â€” Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ… â€”</option>
        <option value="true">âœ”ï¸ Ø¯Ù„ÙŠÙ„ ØµØ­ÙŠØ­</option>
        <option value="false">âŒ Ø¯Ù„ÙŠÙ„ Ø®Ø§Ø·Ø¦</option>
      </select>
      <button class="btn" id="btnApplyEvidence">ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <!-- Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
    <h2>ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
    <div class="row">
      <input id="duration" type="number" value="120" title="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ">
      <button class="btn" id="btnGameStart">Ø¨Ø¯Ø¡</button>
      <button class="btn-ghost" id="btnGameStop">Ø¥ÙŠÙ‚Ø§Ù</button>
      <button class="btn-ghost" id="btnGameFinalize">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
    </div>

    <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <h2>ğŸ—’ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
    <button class="btn" id="btnNoteMode">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø±ÙŠÙƒ -->
    <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø±ÙŠÙƒ</h2>
    <div class="row">
      <label style="font-size:12px;color:#cdd6e1">Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ©:</label>
      <select id="stepSel">
        <option value="0.05">Ø¨Ø·ÙŠØ¦Ø© (0.05)</option>
        <option value="0.1" selected>Ù…ØªÙˆØ³Ø·Ø© (0.1)</option>
        <option value="0.25">Ø³Ø±ÙŠØ¹Ø© (0.25)</option>
        <option value="0.5">Ø¹Ø§Ù„ÙŠØ© (0.5)</option>
      </select>
    </div>
  </aside>
</div>

<!-- Ø£Ø³Ù‡Ù… Ø§Ù„ØªØ­ÙƒÙ… -->
<div id="controls">
  <div class="ctrl" data-act="up"     title="Ø£Ø¹Ù„Ù‰">ğŸ”¼</div>
  <div class="ctrl" data-act="down"   title="Ø£Ø³ÙÙ„">ğŸ”½</div>
  <div class="ctrl" data-act="left"   title="ÙŠØ³Ø§Ø±">â—€ï¸</div>
  <div class="ctrl" data-act="right"  title="ÙŠÙ…ÙŠÙ†">â–¶ï¸</div>
  <div class="ctrl" data-act="fwd"    title="Ø£Ù…Ø§Ù…">â«</div>
  <div class="ctrl" data-act="back"   title="Ø®Ù„Ù">â¬</div>
  <div class="ctrl" data-act="rotL"   title="ØªØ¯ÙˆÙŠØ± ÙŠØ³Ø§Ø±">âŸ²</div>
  <div class="ctrl" data-act="rotR"   title="ØªØ¯ÙˆÙŠØ± ÙŠÙ…ÙŠÙ†">âŸ³</div>
  <div class="ctrl" data-act="plus"   title="ØªÙƒØ¨ÙŠØ±">âŠ•</div>
  <div class="ctrl" data-act="minus"  title="ØªØµØºÙŠØ±">âŠ–</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© -->
<div id="noteModal">
  <div class="noteCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <strong style="color:#d4af37">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</strong>
      <button class="btn-ghost" id="noteCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <label>Ø§Ù„Ù†Øµ:</label>
    <textarea id="noteText" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·..."></textarea>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="noteSave">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ (Ù…Ø¶Ù…ÙˆÙ†) =====
   - Ù„Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.
   - Ù†Ø²ÙŠÙ„ Ø§Ù„ØºÙ„Ø§Ù Ø«Ù… Ù†Ø´ØºÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ø­Ø§Ø¬Ø¨.
*/
window.startApp = function(){
  const btnStart = document.getElementById('btnStart');
  const ov = document.getElementById('overlayStart');

  // ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
  if(btnStart){
    btnStart.style.transition='transform .18s ease, box-shadow .18s ease';
    btnStart.style.transform='scale(.96)';
    btnStart.style.boxShadow='0 0 22px rgba(212,175,55,.8)';
    setTimeout(()=>{ btnStart.style.transform='scale(1)'; btnStart.style.boxShadow='0 0 14px rgba(212,175,55,.5)'; }, 180);
  }

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØºÙ„Ø§Ù ÙÙˆØ±Ù‹Ø§
  if(ov){
    ov.style.transition='opacity .6s ease';
    ov.style.opacity='0';
    setTimeout(()=> ov.remove(), 650);
  }

  // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ±Ø­ÙŠØ¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ (ØºÙŠØ± Ø­Ø§Ø¬Ø¨)
  setTimeout(()=>{
    try{
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance('Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ØŒ Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡');
      u.lang='ar'; u.rate=1; u.pitch=.9;
      const voices = speechSynthesis.getVoices();
      const male = voices.find(v => /ar/i.test(v.lang) && /male|google.*arabic/i.test(v.name)) || voices.find(v=>/ar/i.test(v.lang));
      if(male) u.voice=male;
      // Ù„Ø§ Ù†Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØª Ø´Ø±Ø·Ù‹Ø§ Ù„Ù„Ø¨Ø¯Ø¡
      speechSynthesis.cancel();
      // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØ­ØªØ§Ø¬ resume Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (typeof speechSynthesis.resume === 'function') speechSynthesis.resume();
      speechSynthesis.speak(u);
    }catch(e){}
  }, 900);
};

/* ===== Ø¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© (ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ…Ø§Ù…Ù‹Ø§) ===== */
const sidebar = document.getElementById('sidebar');
document.getElementById('btnOpen').onclick  = ()=> sidebar.classList.remove('hidden');
document.getElementById('btnClose').onclick = ()=> sidebar.classList.add('hidden');
const toast = document.getElementById('toast');
function msg(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1100); }
const timeEl = document.getElementById('time');
const statusEl = document.getElementById('status');
const scoreEl = document.getElementById('score');

const scene = document.querySelector('a-scene');
const ray   = document.getElementById('ray');

/* Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© */
const library = [
  {name:'Ø³ÙƒÙŠÙ†',         url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/ReciprocatingSaw/glTF-Binary/ReciprocatingSaw.glb'},
  {name:'Ù‚ÙŠØ¯ Ø­Ø¯ÙŠØ¯ÙŠ',         url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/scene_compressed.glb'},
  {name:'Ø®ÙˆØ°Ø© Ù…ØªØ¶Ø±Ø±Ø©',  url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'},
  {name:'Ø¨Ù‚Ø¹Ø© Ø¯Ù…',      url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Avocado/glTF-Binary/Avocado.glb'},
  {name:'BoomBox',      url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoomBox/glTF-Binary/BoomBox.glb'},
  {name:'Ø¨Ø·Ø©',          url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF-Binary/Duck.glb'}
];
function renderLibrary(){
  const lib = document.getElementById('library'); lib.innerHTML = '';
  library.forEach((m,i)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="font-weight:800">${m.name}</div><button class="btn">ÙˆØ¶Ø¹</button>`;
    card.querySelector('button').onclick = ()=> placeModel(i);
    lib.appendChild(card);
  });
}
renderLibrary();

let placed = []; // {id,name,el,scored:false}
let selected = null;
const placedList = document.getElementById('placedList');
const evidenceSel = document.getElementById('evidenceSel');

function placeModel(i){
  const m = library[i]; if(!m) return;
  const id = 'ent-'+Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', id);
  ent.setAttribute('gltf-model', m.url);
  ent.setAttribute('position', `${(Math.random()*2-1).toFixed(2)} 0 ${(Math.random()*-2-2).toFixed(2)}`);
  ent.setAttribute('rotation','0 0 0');
  ent.setAttribute('scale','1 1 1');
  ent.classList.add('placed','clickable');
  ent.setAttribute('data-valid','none');   // none / true / false
  ent.setAttribute('data-scored','no');    // yes/no

  const col=document.createElement('a-box');
  col.setAttribute('width','1.2'); col.setAttribute('height','1.8'); col.setAttribute('depth','1.2');
  col.setAttribute('opacity','0'); col.setAttribute('position','0 0.9 0'); col.classList.add('clickable');
  ent.appendChild(col);

  scene.appendChild(ent);
  placed.push({id,name:m.name,el:ent,scored:false});

  const opt=document.createElement('option'); opt.value=id; opt.textContent=m.name; placedList.appendChild(opt);
  selectById(id);
  msg('ØªÙ… ÙˆØ¶Ø¹ '+m.name);
}
function selectById(id){
  const rec = placed.find(p=>p.id===id); if(!rec) return;
  selected = rec.el; placedList.value = id;
  evidenceSel.value = selected.getAttribute('data-valid') || 'none';
}
placedList.onchange = e => selectById(e.target.value);

function findAncestor(el, pred){
  let cur = el;
  while(cur && cur !== scene){
    if(pred(cur)) return cur;
    cur = cur.parentEl;
  }
  return null;
}

ray.addEventListener('click',(ev)=>{
  const el = ev.detail?.intersectedEl; if(!el) return;

  const ent = findAncestor(el, e=> e.classList && e.classList.contains('placed'));
  if(ent){ const rec = placed.find(p=>p.el===ent || p.id===ent.id); if(rec) selectById(rec.id); }

  handleNoteClick(ev);

  if(timer){
    const target = findAncestor(el, e=> e.classList && e.classList.contains('placed'));
    if(target){
      const valid = target.getAttribute('data-valid');
      const scored = target.getAttribute('data-scored');
      if(scored==='yes') return;
      if(valid==='true'){ addScore(10); flashHalo(target, '#39d98a'); target.setAttribute('data-scored','yes'); }
      else if(valid==='false'){ addScore(-5); flashHalo(target, '#ff5c5c'); target.setAttribute('data-scored','yes'); }
    }
  }
});

document.getElementById('btnDelete').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const id = placedList.value;
  try{ scene.removeChild(selected); }catch(e){}
  placed = placed.filter(p=>p.id!==id);
  [...placedList.options].forEach(o=>{ if(o.value===id) o.remove(); });
  selected=null; evidenceSel.value='none';
  msg('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±');
};

document.getElementById('btnReset').onclick = ()=>{
  placed.forEach(p=>{ try{ scene.removeChild(p.el); }catch(e){} });
  placed=[]; placedList.innerHTML='';
  document.querySelectorAll('.noteMarker').forEach(n=>{ try{ n.parentEl.removeChild(n); }catch(e){} });
  selected=null; evidenceSel.value='none';
  endTimer(true);
  score = 0; scoreEl.textContent='0'; statusEl.textContent='ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·';
  msg('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯');
};

function updateEvidenceStyle(ent){
  [...ent.children].filter(c=> c.classList && c.classList.contains('evidenceHalo')).forEach(h=>ent.removeChild(h));
  const val = ent.getAttribute('data-valid');
  if(val==='true' || val==='false'){
    const halo = document.createElement('a-torus');
    halo.classList.add('evidenceHalo');
    halo.setAttribute('radius','0.6'); halo.setAttribute('radius-tubular','0.02');
    halo.setAttribute('rotation','90 0 0'); halo.setAttribute('position','0 0.05 0');
    const col = (val==='true') ? '#39d98a' : '#ff5c5c';
    halo.setAttribute('material',`color:${col}; emissive:${col}; emissiveIntensity:0.5; opacity:0.85; transparent:true`);
    ent.appendChild(halo);
  }
}
document.getElementById('btnApplyEvidence').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const val = evidenceSel.value;
  selected.setAttribute('data-valid', val);
  selected.setAttribute('data-scored','no');
  updateEvidenceStyle(selected);
  msg('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¯Ù„ÙŠÙ„');
};

function num(n){ return typeof n==='number' ? n : parseFloat(n)||0; }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function stepVal(){ return parseFloat(document.getElementById('stepSel').value)||0.1; }
document.querySelectorAll('#controls .ctrl').forEach(btn=>{
  btn.onclick = ()=>{
    if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const act = btn.dataset.act, step = stepVal();
    const pos = selected.getAttribute('position');
    const rot = selected.getAttribute('rotation');
    const sc  = selected.getAttribute('scale');
    if(act==='up')   pos.y = +(num(pos.y)+step).toFixed(2);
    if(act==='down') pos.y = +(num(pos.y)-step).toFixed(2);
    if(act==='left') pos.x = +(num(pos.x)-step).toFixed(2);
    if(act==='right')pos.x = +(num(pos.x)+step).toFixed(2);
    if(act==='fwd')  pos.z = +(num(pos.z)-step).toFixed(2);
    if(act==='back') pos.z = +(num(pos.z)+step).toFixed(2);
    if(act==='rotL') rot.y = +(num(rot.y)-15).toFixed(2);
    if(act==='rotR') rot.y = +(num(rot.y)+15).toFixed(2);
    if(act==='plus'){ const s=num(sc.x)+step; sc.x=sc.y=sc.z=clamp(+s.toFixed(2),0.05,10); }
    if(act==='minus'){const s=num(sc.x)-step; sc.x=sc.y=sc.z=clamp(+s.toFixed(2),0.05,10); }
    selected.setAttribute('position', pos);
    selected.setAttribute('rotation', rot);
    selected.setAttribute('scale', sc);
  };
});

/* ===== Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) Ù…Ø¹ Zoom-in/Zoom-out ÙˆØµÙˆØª/ÙˆÙ…ÙŠØ¶ ===== */
let noteModeActive = false;
let pendingPoint = null;
const noteModal = document.getElementById('noteModal');
const noteText = document.getElementById('noteText');

document.getElementById('btnNoteMode').onclick = ()=>{
  noteModeActive=true; statusEl.textContent='ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØ¹Ù„'; msg('Ø§Ø¶ØºØ· ÙÙŠ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
};

function safeTextValue(s){ return (s||'').toString().replace(/;/g,'Ø›'); }
function estimateHeight(text, wrap){
  const t = (text||'').length ? text : ' ';
  const lines = Math.max(1, Math.ceil(t.length / wrap));
  const lineH = 0.18;  const pad = 0.26;
  return +(pad + lines*lineH).toFixed(2);
}
function createNoteAt(point, text) {
  const marker = document.createElement('a-entity');
  marker.classList.add('noteMarker','clickable');
  marker.setAttribute('position', `${point.x} ${Math.max(0.05,point.y)} ${point.z}`);
  marker.setAttribute('data-note', text || '');

  // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
  const dot = document.createElement('a-sphere');
  dot.setAttribute('radius','0.09');
  dot.setAttribute('material','color:#d4af37; emissive:#b78f2a; emissiveIntensity:0.5; metalness:0.4; roughness:0.3');
  dot.classList.add('clickable');
  marker.appendChild(dot);

  // Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·)
  const noteBox = document.createElement('a-entity');
  noteBox.setAttribute('visible','false');
  noteBox.setAttribute('position','0 1.0 0');

  // Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø°Ù‡Ø¨ÙŠØ©
  const bg = document.createElement('a-plane');
  bg.setAttribute('width','3.2');
  bg.setAttribute('height','1.6');
  bg.setAttribute('material','color:#0a0c0f; opacity:0.88; side:double; metalness:0.2; roughness:0.4; emissive:#d4af37; emissiveIntensity:0.15');
  bg.setAttribute('radius','0.12');
  noteBox.appendChild(bg);

  // Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
  const txt = document.createElement('a-entity');
  txt.setAttribute('text', `value:${safeTextValue(text)}; color:#fff; align:center; wrapCount:40; width:3;`);
  txt.setAttribute('position','0 0 0.02');
  noteBox.appendChild(txt);

  // Ø£Ø²Ø±Ø§Ø±
  const btnEdit = document.createElement('a-entity');
  btnEdit.setAttribute('text','value:âœï¸; color:#d4af37; align:left; width:1;');
  btnEdit.setAttribute('position','-1.3 0.6 0.02');
  btnEdit.classList.add('clickable');
  noteBox.appendChild(btnEdit);

  const btnDelete = document.createElement('a-entity');
  btnDelete.setAttribute('text','value:ğŸ—‘ï¸; color:#d4af37; align:center; width:1;');
  btnDelete.setAttribute('position','0 0.6 0.02');
  btnDelete.classList.add('clickable');
  noteBox.appendChild(btnDelete);

  const btnClose = document.createElement('a-entity');
  btnClose.setAttribute('text','value:âœ–ï¸; color:#d4af37; align:right; width:1;');
  btnClose.setAttribute('position','1.3 0.6 0.02');
  btnClose.classList.add('clickable');
  noteBox.appendChild(btnClose);

  marker.appendChild(noteBox);

  // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ù‚Ø±
  dot.addEventListener('click', e => {
    e.stopPropagation();
    const visible = noteBox.getAttribute('visible');
    if(!visible){
      noteBox.setAttribute('visible','true');
      playPop();
    } else {
      noteBox.setAttribute('visible','false');
    }
  });

  btnClose.addEventListener('click', e => {
    e.stopPropagation();
    noteBox.setAttribute('visible','false');
  });

  btnDelete.addEventListener('click', e => {
    e.stopPropagation();
    playDelete();
    try { scene.removeChild(marker); } catch(err){}
  });

  btnEdit.addEventListener('click', e => {
    e.stopPropagation();
    const newText = prompt('ğŸ“ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:', marker.getAttribute('data-note') || '');
    if(newText !== null){
      marker.setAttribute('data-note', newText);
      txt.setAttribute('text', `value:${safeTextValue(newText)}; color:#fff; align:center; wrapCount:40; width:3;`);
      playPop();
    }
  });

  scene.appendChild(marker);
  return marker;
}


function applyNoteText(marker, text){
  const wrap = 64;
  const safe = safeTextValue(text);
  marker._text.setAttribute('text', `value:${safe}; color:white; align:center; width:3.8; wrapCount:${wrap}; baseline:center; letterSpacing:0;`);
  const h = estimateHeight(safe, wrap);
  marker._bg.setAttribute('height', h);
}
function zoomOpen(marker){
  const blink = document.createElement('a-ring');
  blink.setAttribute('radius-inner','0.12');
  blink.setAttribute('radius-outer','0.2');
  blink.setAttribute('rotation','-90 0 0');
  blink.setAttribute('material','color:#d4af37; opacity:0.9; transparent:true');
  marker.appendChild(blink);
  setTimeout(()=>{ try{ marker.removeChild(blink);}catch(e){} }, 1000);

  const lbl = marker._label;
  lbl.setAttribute('visible','true');
  lbl.setAttribute('scale','0.7 0.7 0.7');
  let start=null;
  function anim(ts){ if(!start) start=ts; const p=Math.min(1,(ts-start)/400); const s=0.7+(1-0.7)*p; lbl.setAttribute('scale', `${s} ${s} ${s}`); if(p<1) requestAnimationFrame(anim); }
  requestAnimationFrame(anim);
  playPop();
}
function zoomClose(marker){
  const lbl = marker._label;
  let start=null;
  function anim(ts){ if(!start) start=ts; const p=Math.min(1,(ts-start)/400); const s=1-(1-0.7)*p; lbl.setAttribute('scale', `${s} ${s} ${s}`); if(p<1) requestAnimationFrame(anim); else lbl.setAttribute('visible','false'); }
  requestAnimationFrame(anim);
}

const AudioCtx = window.AudioContext || window.webkitAudioContext; let actx=null;
function playBeep(freq=660, dur=0.08, type='sine', vol=0.2){ try{ if(!actx) actx=new AudioCtx(); const t=actx.currentTime; const o=actx.createOscillator(); const g=actx.createGain(); o.type=type;o.frequency.value=freq; g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.connect(g).connect(actx.destination); o.start(t); o.stop(t+dur);}catch(e){} }
function playPop(){ playBeep(740,0.10,'sine',0.22); }
function playDelete(){ playBeep(320,0.12,'triangle',0.18); }

function handleNoteClick(ev) {
  const inter = ev.detail?.intersection;
  const hitEl = ev.detail?.intersectedEl;
  if (!inter || !hitEl) return;

  // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
  if (noteModeActive) {
    pendingPoint = inter.point;
    noteText.value = "";
    noteModal.style.display = "grid";
    return;
  }

  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ù‚ØµÙˆØ¯Ø©
  const marker = findAncestor(hitEl, e => e.classList && e.classList.contains("noteMarker"));
  if (marker) {
    const t = marker.getAttribute("data-note") || "";
    if (!t.trim()) return;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ÙƒÙ„ Ø¶ØºØ·
    applyNoteText(marker, t);

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø·ÙˆÙ„ Ø§Ù„Ù†Øµ
    const wrap = 64;
    const safe = safeTextValue(t);
    const h = estimateHeight(safe, wrap);
    marker._bg.setAttribute("height", h);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ø¹ Ø§Ù„ØªØ£Ø«ÙŠØ±
    zoomOpen(marker);
  }
}

document.getElementById('noteSave').onclick = ()=>{
  const t = noteText.value.trim();
  if(!pendingPoint){ document.getElementById('noteModal').style.display='none'; return; }
  const marker = createNoteAt(pendingPoint, t);
  zoomOpen(marker);
  pendingPoint=null; document.getElementById('noteModal').style.display='none';
  noteModeActive=false; statusEl.textContent='Ø¬Ø§Ù‡Ø²';
};
document.getElementById('noteCancel').onclick = ()=>{
  pendingPoint=null; document.getElementById('noteModal').style.display='none'; statusEl.textContent='Ø¬Ø§Ù‡Ø²'; noteModeActive=false;
};

/* Ø§Ù„Ù…Ø¤Ù‚Øª + Ø§Ù„Ù†Ù‚Ø§Ø· */
let timeLeft=0, timer=null, score=0;
function fmt(t){ const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
function endTimer(resetOnly=false){ if(timer){ clearInterval(timer); timer=null; } if(resetOnly){ timeLeft=0; timeEl.textContent='--:--'; statusEl.textContent='Ø¬Ø§Ù‡Ø²'; return; } statusEl.textContent='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª'; }
function animateNumber(el, from, to, dur=350){ const start=performance.now(); function step(now){ const p=Math.min(1,(now-start)/dur); const val = Math.round(from + (to-from)*p); el.textContent = String(val); if(p<1) requestAnimationFrame(step); } requestAnimationFrame(step); }
function addScore(delta){ const prev=score; score = Math.max(0, score + delta); animateNumber(scoreEl, prev, score); }
const durInp = document.getElementById('duration');
document.getElementById('btnGameStart').onclick = ()=>{
  timeLeft = parseInt(durInp.value)||120;
  if(timer) clearInterval(timer);
  timeEl.textContent = fmt(timeLeft);
  statusEl.textContent='Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
  placed.forEach(p=>{ if(p.el) p.el.setAttribute('data-scored','no'); });
  timer = setInterval(()=>{ timeLeft--; timeEl.textContent=fmt(timeLeft); if(timeLeft<=0){ endTimer(); msg('â±ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª'); } },1000);
};
document.getElementById('btnGameStop').onclick = ()=>{ endTimer(); msg('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'); };
document.getElementById('btnGameFinalize').onclick = ()=>{ msg(`ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ â€” Ù†Ù‚Ø§Ø·Ùƒ: ${score}`); };

function flashHalo(ent, color){
  const halo = document.createElement('a-ring');
  halo.setAttribute('radius-inner','0.5'); halo.setAttribute('radius-outer','0.6'); halo.setAttribute('rotation','-90 0 0');
  halo.setAttribute('material',`color:${color}; opacity:0.9; transparent:true`);
  ent.appendChild(halo);
  setTimeout(()=>{ try{ ent.removeChild(halo);}catch(e){} }, 350);
}
</script>
</body>
</html>
