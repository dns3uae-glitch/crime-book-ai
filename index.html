<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>مسرح جريمة ثلاثي الأبعاد</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-super-hands-component@4.0.5/dist/aframe-super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-gizmo@1.0.0/dist/aframe-gizmo.min.js"></script>
  <script src="https://unpkg.com/aframe-draggable-component/dist/aframe-draggable-component.min.js"></script>
  <style>
    :root { --bg:#0f1112; --panel:#131516; --accent:#c59e2b; --muted:#9aa0a6; color-scheme: dark; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#fff}
    #app{display:flex;height:100vh;gap:10px}
    #sidebar{width:360px;background:var(--panel);padding:12px;overflow:auto;border-right:1px solid rgba(255,255,255,0.04)}
    h2{margin:6px 0 12px 0;font-size:18px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], input[type="url"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0c0d0e;color:#fff}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#081217;cursor:pointer;margin-top:8px;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
    .item{background:#0b0c0d;padding:8px;border-radius:8px;margin-top:8px;display:flex;gap:8px;align-items:center}
    .list{margin-top:10px}
    #sceneWrap{flex:1;position:relative}
    #hud{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:gold;z-index:2}
    #controls{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;z-index:2}
    #message{position:absolute;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:8px;z-index:2}
    .selected{outline:2px solid #2ecc71}
    #timer{font-weight:900;color:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>📦 إضافة نموذج GLB</h2>
    <label>اسم العنصر</label>
    <input id="modelName" type="text" placeholder="مثال: سكين">
    <label>رابط النموذج</label>
    <input id="modelUrl" type="url" placeholder="https://.../model.glb">

    <div style="display:flex;gap:8px;">
      <button id="addBtn">➕ أضف</button>
    </div>

    <h2>📚 مكتبة الأدلة</h2>
    <div id="library" class="list"></div>
<button id="clearLibraryBtn" class="btn-ghost">🧹 حذف المكتبة المحفوظة</button>

<h2>📌 اختر نقطة مرجعية</h2>
<select id="refSelector">
  <option value="ref-center">وسط الغرفة</option>
  <option value="ref-left">الجانب الأيسر</option>
  <option value="ref-right">الجانب الأيمن</option>
  <option value="ref-bed">جانب السرير</option>
  <option value="ref-door">قرب الباب</option>
</select>

    <h2>📋 الأدلة المضافة</h2>
    <select id="placedSelector" size="6" style="width:100%;margin-top:6px"></select>
    <div style="display:flex;gap:6px;margin-top:8px">
      <select id="placedType">
        <option value="true">✔️ دليل صحيح</option>
        <option value="false">❌ ليس دليلًا</option>
      </select>
      <button id="updateTypeBtn">🔄 تحديث النوع</button>
    </div>

    <h2>🖱 التحكم في النموذج</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button id="modeTranslate" class="btn-ghost">🔁 تحريك</button>
      <button id="modeRotate" class="btn-ghost">⟳ تدوير</button>
      <button id="modeScale" class="btn-ghost">⤢ تكبير/تصغير</button>
      <button id="confirmBtn">✅ اعتماد الموقع</button>
      <button id="deleteBtn" class="btn-ghost">🗑 حذف</button>
    </div>

    <h2>🧭 تعديل يدوي للموقع</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn-ghost" onclick="rotateSelected('x')">🔄 ميلان X</button>
      <button class="btn-ghost" onclick="rotateSelected('y')">🔄 ميلان Y</button>
      <button class="btn-ghost" onclick="rotateSelected('z')">🔄 ميلان Z</button>
      <button class="btn-ghost" onclick="raiseSelected()">⬆ رفع</button>
      <button class="btn-ghost" onclick="lowerSelected()">⬇ خفض</button>
<button class="btn-ghost" onclick="moveSelected('left')">⬅ يسار</button>
<button class="btn-ghost" onclick="moveSelected('right')">➡ يمين</button>
<button class="btn-ghost" onclick="moveSelected('forward')">⬆ أمام</button>
<button class="btn-ghost" onclick="moveSelected('backward')">⬇ خلف</button>

    </div>

    <h2>⏱ الاختبار</h2>
    <label>مدة الاختبار (ثواني)</label>
    <input id="duration" type="text" value="120">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="startBtn">▶️ ابدأ</button>
      <button id="stopBtn" class="btn-ghost">⏹ إيقاف</button>
    </div>
    <div style="margin-top:12px"><strong>نقاط:</strong> <span id="scorePanel">0</span></div>

    <h2>📊 النتيجة النهائية</h2>
    <button id="finalizeBtn">📊 اعتماد اختيار الأدلة</button>
  </div> <!-- نهاية sidebar -->

  <div id="sceneWrap">
    <div id="hud">النقاط: <span id="score">0</span></div>
    <div id="controls">
      <div>الوقت: <span id="timer">--:--</span></div>
    </div>
    <div id="message"></div>

    <a-scene id="scene" background="color: #111" embedded vr-mode-ui="enabled: false">
      <!-- الأرضية والجدران -->
      <a-plane rotation="-90 0 0" width="10" height="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/laminate_floor_02.png?height=760&quality=95; repeat: 4 4"></a-plane>
      <a-box position="0 1.6 -5" width="10" height="3" depth="0.1"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>
      <a-box position="-5 1.6 0" width="0.1" height="3" depth="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>
      <a-box position="5 1.6 0" width="0.1" height="3" depth="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>

      <!-- إضاءة وكاميرا -->
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="2 4 2"></a-entity>
      <a-entity id="cameraRig" position="0 1.6 3">
        <a-entity camera look-controls wasd-controls></a-entity>
      </a-entity>

      <!-- نقاط مرجعية -->
      <a-entity id="ref-center" position="0 1 -2" visible="false"></a-entity>
      <a-entity id="ref-left" position="-2 1 -2" visible="false"></a-entity>
      <a-entity id="ref-right" position="2 1 -2" visible="false"></a-entity>
      <a-entity id="ref-bed" position="-1 1 -4" visible="false"></a-entity>
      <a-entity id="ref-door" position="1 1 2" visible="false"></a-entity>

      <!-- تفعيل التحكم بالماوس أو اللمس -->
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable" super-hands></a-entity>
    </a-scene>
  </div>
</div> <!-- نهاية app -->
<script>
const libraryEl = document.getElementById('library');
const addBtn = document.getElementById('addBtn');
const modelNameInput = document.getElementById('modelName');
const modelUrlInput = document.getElementById('modelUrl');
const refSelector = document.getElementById('refSelector');
const confirmBtn = document.getElementById('confirmBtn');
const deleteBtn = document.getElementById('deleteBtn');
const modeTranslate = document.getElementById('modeTranslate');
const modeRotate = document.getElementById('modeRotate');
const modeScale = document.getElementById('modeScale');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const finalizeBtn = document.getElementById('finalizeBtn');
const durationInput = document.getElementById('duration');
const scorePanel = document.getElementById('scorePanel');
const scoreHud = document.getElementById('score');
const message = document.getElementById('message');
const scene = document.getElementById('scene');
const timerText = document.getElementById('timer');
const placedSelector = document.getElementById('placedSelector');
const placedType = document.getElementById('placedType');
const updateTypeBtn = document.getElementById('updateTypeBtn');
const clearLibraryBtn = document.getElementById('clearLibraryBtn'); // ✅ زر حذف المكتبة

let library = [];
let placed = [];
let selected = null;
let score = 0;
let timerInterval = null;
let timeLeft = 0;

/* إضافة نموذج إلى المكتبة */
addBtn.addEventListener('click', ()=>{
  const name = modelNameInput.value.trim() || 'عنصر';
  const url = modelUrlInput.value.trim();
  const valid = placedType.value;
  if(!url){ alert('يرجى إدخال رابط صالح'); return; }
  if(!valid){ alert('يرجى اختيار نوع الدليل'); return; }
  const id = 'm'+Date.now();
  library.push({id,name,url,valid});
  localStorage.setItem('evidenceLibrary', JSON.stringify(library));
  modelNameInput.value=''; modelUrlInput.value='';
  renderLibrary();
});



/* عرض المكتبة */
function renderLibrary(){
  libraryEl.innerHTML = '';
  library.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div style="flex:1">
        <div class="row"><strong>${escapeHtml(item.name)}</strong></div>
        <div style="font-size:12px;color:#8f999f;margin-top:6px">${escapeHtml(item.url)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost" onclick="previewModel('${item.url}')">👁 معاينة</button>
        <button class="btn-ghost" onclick="placeModel('${item.id}')">📍 وضع</button>
      </div>
    `;
    libraryEl.appendChild(div);
  });
}

/* معاينة النموذج */
window.previewModel = function(url){
  const tempId = 'preview-'+Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', tempId);
  ent.setAttribute('gltf-model', url);
  ent.setAttribute('position', '0 1 -1');
  ent.setAttribute('scale','0.6 0.6 0.6');
  scene.appendChild(ent);
  message.textContent = '👁 معاينة النموذج...';
  setTimeout(()=>{ message.textContent=''; try{ scene.removeChild(ent);}catch(e){} },6000);
}

/* وضع النموذج */
window.placeModel = function(libId){
  const lib = library.find(l=>l.id===libId);
  if(!lib) return;

  const refId = refSelector?.value || 'ref-center';
  const ref = document.getElementById(refId);
  const refPos = ref?.getAttribute('position') || {x:0, y:1, z:-2};

  const isValid = placedType.value;

  const ent = document.createElement('a-entity');
  const pid = 'p'+Date.now();
  ent.setAttribute('id', pid);
  ent.setAttribute('gltf-model', lib.url);
  ent.setAttribute('position', `${refPos.x} ${refPos.y} ${refPos.z}`);
  ent.setAttribute('scale', '1 1 1');
  ent.setAttribute('gizmo', 'mode: translate; rotation: true; scale: true; size: 1.5');
  ent.setAttribute('class', 'placed clickable');
  ent.setAttribute('data-evidence','true');
  ent.setAttribute('data-valid', isValid);
  ent.setAttribute('draggable', 'true');
  ent.setAttribute('grabbable', 'true');
  ent.setAttribute('stretchable', 'true');
  ent.setAttribute('rotatable', 'true');
  ent.setAttribute('shadow', 'receive: true; cast: true');
  ent.setAttribute('raycastable', 'true');

  // ✅ كوليدر غير مرئي
  const collider = document.createElement('a-box');
  collider.setAttribute('position', '0 1 0');
  collider.setAttribute('width', '1');
  collider.setAttribute('height', '2');
  collider.setAttribute('depth', '0.5');
  collider.setAttribute('opacity', '0');
  collider.setAttribute('class', 'clickable');
  ent.appendChild(collider);

  scene.appendChild(ent);
  placed.push({id:pid,name:lib.name,el:ent});

  const option = document.createElement('option');
  option.value = pid;
  option.textContent = lib.name;
  placedSelector.appendChild(option);

  selectPlaced(pid);
}

/* اختيار من القائمة */
placedSelector.addEventListener('change', (e)=>{
  const id = e.target.value;
  selectPlaced(id);
  message.textContent = `📌 تم تحديد: ${selected.name}`;
});

/* تحديث نوع الدليل */
scene.addEventListener('click', (ev) => {
  const el = ev.target;
  const ent = el.closest ? el.closest('a-entity') : null;
  if (!ent) return;

  // ✅ جمع الأدلة أثناء الاختبار
  if (timeLeft > 0 && ent.getAttribute('data-evidence') === 'true') {
    ent.setAttribute('data-evidence', 'collected');
    const valid = ent.getAttribute('data-valid');
    if (valid === 'true') { score += 10; }
    message.textContent = valid === 'true' ? '✅ دليل صحيح تم جمعه' : '❌ هذا ليس دليلًا';
    updateScore();
    setTimeout(() => message.textContent = '', 2000);
  }

  // ✅ تحديد النموذج عند النقر
  const isPlaced = placed.find(p => p.el === ent);
  if (isPlaced) {
    selectPlaced(isPlaced.id);               // تفعيل التحديد
    placedSelector.value = isPlaced.id;      // مزامنة القائمة
    message.textContent = `📌 تم تحديد: ${isPlaced.name}`;
  }
});




/* التحكم اليدوي */
function rotateSelected(axis){
  if(!selected) return alert('اختر عنصرًا أولاً');
  const rot = selected.el.getAttribute('rotation');
  if(axis==='x') rot.x += 90;
  if(axis==='y') rot.y += 90;
  if(axis==='z') rot.z += 90;
  selected.el.setAttribute('rotation', `${rot.x} ${rot.y} ${rot.z}`);
}

function raiseSelected(){
  if(!selected) return alert('اختر عنصرًا أولاً');
  const pos = selected.el.getAttribute('position');
  pos.y += 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}

function lowerSelected(){
  if(!selected) return alert('اختر عنصرًا أولاً');
  const pos = selected.el.getAttribute('position');
  pos.y -= 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}

/* أزرار gizmo */
modeTranslate.addEventListener('click', () => {
  if (!selected) return alert('اختر عنصرًا أولاً');
  selected.el.setAttribute('gizmo', 'mode: translate; size: 1.5');
});
modeRotate.addEventListener('click', () => {
  if (!selected) return alert('اختر عنصرًا أولاً');
  selected.el.setAttribute('gizmo', 'mode: rotate; size: 1.5');
});
modeScale.addEventListener('click', () => {
  if (!selected) return alert('اختر عنصرًا أولاً');
  selected.el.setAttribute('gizmo', 'mode: scale; size: 1.5');
});
confirmBtn.addEventListener('click', () => {
  if (!selected) return alert('اختر عنصرًا أولاً');
  selected.el.removeAttribute('gizmo');
  message.textContent = '✅ تم تثبيت النموذج في الموقع';
});
deleteBtn.addEventListener('click', ()=>{
  if(!selected) return alert('اختر عنصرًا أولاً');

  // حذف العنصر من المسرح
  try { scene.removeChild(selected.el); } catch(e){}

  // حذف العنصر من القائمة
  const optionToRemove = [...placedSelector.options].find(opt => opt.value === selected.id);
  if(optionToRemove) placedSelector.removeChild(optionToRemove);

  // تحديث المصفوفة
  placed = placed.filter(p => p.id !== selected.id);

  // إعادة تعيين التحديد
  selected = null;
  message.textContent = '🗑 تم حذف النموذج من المسرح والقائمة';
});


/* الاختبار */
startBtn.addEventListener('click', ()=>{
  if(placed.length === 0) return alert('ضع عناصر أولاً');

  score = 0;
  updateScore();
  timeLeft = parseInt(durationInput.value) || 120;
  updateTimerDisplay();

  placed.forEach(p => p.el.setAttribute('data-evidence', 'true'));

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      endRound();
    }
  }, 1000);

  // ✅ عرض الرسالة ثم إخفاؤها بعد 3 ثوانٍ
  message.textContent = '⏳ الاختبار بدأ! انقر على الأدلة لجمعها.';
  setTimeout(() => { message.textContent = ''; }, 3000);
});

stopBtn.addEventListener('click', ()=>{ 
  if(timerInterval) clearInterval(timerInterval); 
  message.textContent='⏹ تم الإيقاف.'; 
});
function updateTimerDisplay(){
  const mm = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const ss = (timeLeft%60).toString().padStart(2,'0');
  timerText.textContent = `${mm}:${ss}`;
}
function updateScore(){
  scorePanel.textContent = score;
  scoreHud.textContent = score;
}

function endRound(){
  message.textContent = `⏱ انتهى الوقت! مجموع نقاطك: ${score}`;
  placed.forEach(p => p.el.setAttribute('data-evidence','false'));
}

/* اعتماد اختيار الأدلة */
finalizeBtn.addEventListener('click', () => {
  let correct = 0;
  let wrong = 0;
  placed.forEach(p => {
    const status = p.el.getAttribute('data-evidence');
    const valid = p.el.getAttribute('data-valid');
    if (status === 'collected') {
      if (valid === 'true') {
        correct++;
      } else {
        wrong++;
      }
    }
  });

  message.textContent = `📊 الأدلة الصحيحة: ${correct} | الأدلة الخاطئة: ${wrong}`;
  placed.forEach(p => {
    const valid = p.el.getAttribute('data-valid');
    const label = document.createElement('a-text');
    label.setAttribute('value', valid === 'true' ? '✔ دليل صحيح' : '✖ ليس دليلًا');
    label.setAttribute('color', valid === 'true' ? 'green' : 'red');
    label.setAttribute('position', '0 0.5 0');
    label.setAttribute('align', 'center');
    p.el.appendChild(label);
  });
});

/* دالة الهروب من HTML */
function escapeHtml(s){
  return (s||'').toString().replace(/[&<>"']/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  })[c]);
}

/* مكتبة الأدلة الجاهزة */
function seedExamples(){
  const examples = [
    {name:'سكين', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/ReciprocatingSaw/glTF-Binary/ReciprocatingSaw.glb'},
    {name:'مسدس', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF-Binary/Duck.glb'},
    {name:'بقعة دم', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Avocado/glTF-Binary/Avocado.glb'},
    {name:'هاتف', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Box/glTF-Binary/Box.glb'},
    {name:'حاجز', url:'https://dns3uae-glitch.github.io/crime-book-ai/fall-investigation-scene/source/nft_ipfs_gltf.gltf'},
    {name:'جثة', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb'}
  ];
  examples.forEach(x => {
    library.push({
      id: 'ex' + Math.random().toString(36).slice(2),
      name: x.name,
      url: x.url
    });
  });

  renderLibrary();
}
const savedLibrary = localStorage.getItem('evidenceLibrary');
if (savedLibrary) {
  library = JSON.parse(savedLibrary);
  renderLibrary();
} else {
  seedExamples(); // إذا لم توجد مكتبة محفوظة، استخدم الأمثلة
}
function moveSelected(direction){
  if(!selected) return alert('اختر عنصرًا أولاً');
  const pos = selected.el.getAttribute('position');
  if(direction === 'left') pos.x -= 0.5;
  if(direction === 'right') pos.x += 0.5;
  if(direction === 'forward') pos.z -= 0.5;
  if(direction === 'backward') pos.z += 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}
function selectPlaced(id){
  if(selected && selected.id === id) return;
  selected = placed.find(p=>p.id===id);
  placed.forEach(p=> p.el.setAttribute('material','color','#fff'));
  if(selected){
    selected.el.setAttribute('material','color','#2ecc71');
    selected.el.setAttribute('gizmo', 'mode: translate; rotation: true; scale: true; size: 1.5');
  }
}

</script>
</body>
</html>
