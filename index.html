<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Ù…Ø³Ø±Ø­ Ø¬Ø±ÙŠÙ…Ø© Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-super-hands-component@4.0.5/dist/aframe-super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-gizmo@1.0.0/dist/aframe-gizmo.min.js"></script>
  <script src="https://unpkg.com/aframe-draggable-component/dist/aframe-draggable-component.min.js"></script>
  <style>
    :root { --bg:#0f1112; --panel:#131516; --accent:#c59e2b; --muted:#9aa0a6; color-scheme: dark; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#fff}
    #app{display:flex;height:100vh;gap:10px}
    #sidebar{width:360px;background:var(--panel);padding:12px;overflow:auto;border-right:1px solid rgba(255,255,255,0.04)}
    h2{margin:6px 0 12px 0;font-size:18px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], input[type="url"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0c0d0e;color:#fff}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#081217;cursor:pointer;margin-top:8px;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
    .item{background:#0b0c0d;padding:8px;border-radius:8px;margin-top:8px;display:flex;gap:8px;align-items:center}
    .list{margin-top:10px}
    #sceneWrap{flex:1;position:relative}
    #hud{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:gold;z-index:2}
    #controls{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;z-index:2}
    #message{position:absolute;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:8px;z-index:2}
    .selected{outline:2px solid #2ecc71}
    #timer{font-weight:900;color:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ GLB</h2>
    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±</label>
    <input id="modelName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙŠÙ†">
    <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
    <input id="modelUrl" type="url" placeholder="https://.../model.glb">

    <div style="display:flex;gap:8px;">
      <button id="addBtn">â• Ø£Ø¶Ù</button>
    </div>

    <h2>ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
    <div id="library" class="list"></div>
<button id="clearLibraryBtn" class="btn-ghost">ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button>

<h2>ğŸ“Œ Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©</h2>
<select id="refSelector">
  <option value="ref-center">ÙˆØ³Ø· Ø§Ù„ØºØ±ÙØ©</option>
  <option value="ref-left">Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±</option>
  <option value="ref-right">Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†</option>
  <option value="ref-bed">Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø³Ø±ÙŠØ±</option>
  <option value="ref-door">Ù‚Ø±Ø¨ Ø§Ù„Ø¨Ø§Ø¨</option>
</select>

    <h2>ğŸ“‹ Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</h2>
    <select id="placedSelector" size="6" style="width:100%;margin-top:6px"></select>
    <div style="display:flex;gap:6px;margin-top:8px">
      <select id="placedType">
        <option value="true">âœ”ï¸ Ø¯Ù„ÙŠÙ„ ØµØ­ÙŠØ­</option>
        <option value="false">âŒ Ù„ÙŠØ³ Ø¯Ù„ÙŠÙ„Ù‹Ø§</option>
      </select>
      <button id="updateTypeBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØ¹</button>
    </div>

    <h2>ğŸ–± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button id="modeTranslate" class="btn-ghost">ğŸ” ØªØ­Ø±ÙŠÙƒ</button>
      <button id="modeRotate" class="btn-ghost">âŸ³ ØªØ¯ÙˆÙŠØ±</button>
      <button id="modeScale" class="btn-ghost">â¤¢ ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±</button>
      <button id="confirmBtn">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <button id="deleteBtn" class="btn-ghost">ğŸ—‘ Ø­Ø°Ù</button>
    </div>

    <h2>ğŸ§­ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn-ghost" onclick="rotateSelected('x')">ğŸ”„ Ù…ÙŠÙ„Ø§Ù† X</button>
      <button class="btn-ghost" onclick="rotateSelected('y')">ğŸ”„ Ù…ÙŠÙ„Ø§Ù† Y</button>
      <button class="btn-ghost" onclick="rotateSelected('z')">ğŸ”„ Ù…ÙŠÙ„Ø§Ù† Z</button>
      <button class="btn-ghost" onclick="raiseSelected()">â¬† Ø±ÙØ¹</button>
      <button class="btn-ghost" onclick="lowerSelected()">â¬‡ Ø®ÙØ¶</button>
<button class="btn-ghost" onclick="moveSelected('left')">â¬… ÙŠØ³Ø§Ø±</button>
<button class="btn-ghost" onclick="moveSelected('right')">â¡ ÙŠÙ…ÙŠÙ†</button>
<button class="btn-ghost" onclick="moveSelected('forward')">â¬† Ø£Ù…Ø§Ù…</button>
<button class="btn-ghost" onclick="moveSelected('backward')">â¬‡ Ø®Ù„Ù</button>

    </div>

    <h2>â± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
    <label>Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø«ÙˆØ§Ù†ÙŠ)</label>
    <input id="duration" type="text" value="120">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
      <button id="stopBtn" class="btn-ghost">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
    <div style="margin-top:12px"><strong>Ù†Ù‚Ø§Ø·:</strong> <span id="scorePanel">0</span></div>

    <h2>ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
    <button id="finalizeBtn">ğŸ“Š Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¯Ù„Ø©</button>
  </div> <!-- Ù†Ù‡Ø§ÙŠØ© sidebar -->

  <div id="sceneWrap">
    <div id="hud">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
    <div id="controls">
      <div>Ø§Ù„ÙˆÙ‚Øª: <span id="timer">--:--</span></div>
    </div>
    <div id="message"></div>

    <a-scene id="scene" background="color: #111" embedded vr-mode-ui="enabled: false">
      <!-- Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯Ø±Ø§Ù† -->
      <a-plane rotation="-90 0 0" width="10" height="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/laminate_floor_02.png?height=760&quality=95; repeat: 4 4"></a-plane>
      <a-box position="0 1.6 -5" width="10" height="3" depth="0.1"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>
      <a-box position="-5 1.6 0" width="0.1" height="3" depth="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>
      <a-box position="5 1.6 0" width="0.1" height="3" depth="10"
        material="src: https://cdn.polyhaven.com/asset_img/primary/snow_02.png?height=760&quality=95; repeat: 2 1"></a-box>

      <!-- Ø¥Ø¶Ø§Ø¡Ø© ÙˆÙƒØ§Ù…ÙŠØ±Ø§ -->
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="2 4 2"></a-entity>
      <a-entity id="cameraRig" position="0 1.6 3">
        <a-entity camera look-controls wasd-controls></a-entity>
      </a-entity>

      <!-- Ù†Ù‚Ø§Ø· Ù…Ø±Ø¬Ø¹ÙŠØ© -->
      <a-entity id="ref-center" position="0 1 -2" visible="false"></a-entity>
      <a-entity id="ref-left" position="-2 1 -2" visible="false"></a-entity>
      <a-entity id="ref-right" position="2 1 -2" visible="false"></a-entity>
      <a-entity id="ref-bed" position="-1 1 -4" visible="false"></a-entity>
      <a-entity id="ref-door" position="1 1 2" visible="false"></a-entity>

      <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³ -->
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable" super-hands></a-entity>
    </a-scene>
  </div>
</div> <!-- Ù†Ù‡Ø§ÙŠØ© app -->
<script>
const libraryEl = document.getElementById('library');
const addBtn = document.getElementById('addBtn');
const modelNameInput = document.getElementById('modelName');
const modelUrlInput = document.getElementById('modelUrl');
const refSelector = document.getElementById('refSelector');
const confirmBtn = document.getElementById('confirmBtn');
const deleteBtn = document.getElementById('deleteBtn');
const modeTranslate = document.getElementById('modeTranslate');
const modeRotate = document.getElementById('modeRotate');
const modeScale = document.getElementById('modeScale');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const finalizeBtn = document.getElementById('finalizeBtn');
const durationInput = document.getElementById('duration');
const scorePanel = document.getElementById('scorePanel');
const scoreHud = document.getElementById('score');
const message = document.getElementById('message');
const scene = document.getElementById('scene');
const timerText = document.getElementById('timer');
const placedSelector = document.getElementById('placedSelector');
const placedType = document.getElementById('placedType');
const updateTypeBtn = document.getElementById('updateTypeBtn');
const clearLibraryBtn = document.getElementById('clearLibraryBtn'); // âœ… Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªØ¨Ø©

let library = [];
let placed = [];
let selected = null;
let score = 0;
let timerInterval = null;
let timeLeft = 0;

/* Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© */
addBtn.addEventListener('click', ()=>{
  const name = modelNameInput.value.trim() || 'Ø¹Ù†ØµØ±';
  const url = modelUrlInput.value.trim();
  const valid = placedType.value;
  if(!url){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­'); return; }
  if(!valid){ alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¯Ù„ÙŠÙ„'); return; }
  const id = 'm'+Date.now();
  library.push({id,name,url,valid});
  localStorage.setItem('evidenceLibrary', JSON.stringify(library));
  modelNameInput.value=''; modelUrlInput.value='';
  renderLibrary();
});



/* Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØªØ¨Ø© */
function renderLibrary(){
  libraryEl.innerHTML = '';
  library.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div style="flex:1">
        <div class="row"><strong>${escapeHtml(item.name)}</strong></div>
        <div style="font-size:12px;color:#8f999f;margin-top:6px">${escapeHtml(item.url)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost" onclick="previewModel('${item.url}')">ğŸ‘ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        <button class="btn-ghost" onclick="placeModel('${item.id}')">ğŸ“ ÙˆØ¶Ø¹</button>
      </div>
    `;
    libraryEl.appendChild(div);
  });
}

/* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
window.previewModel = function(url){
  const tempId = 'preview-'+Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', tempId);
  ent.setAttribute('gltf-model', url);
  ent.setAttribute('position', '0 1 -1');
  ent.setAttribute('scale','0.6 0.6 0.6');
  scene.appendChild(ent);
  message.textContent = 'ğŸ‘ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...';
  setTimeout(()=>{ message.textContent=''; try{ scene.removeChild(ent);}catch(e){} },6000);
}

/* ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
window.placeModel = function(libId){
  const lib = library.find(l=>l.id===libId);
  if(!lib) return;

  const refId = refSelector?.value || 'ref-center';
  const ref = document.getElementById(refId);
  const refPos = ref?.getAttribute('position') || {x:0, y:1, z:-2};

  const isValid = placedType.value;

  const ent = document.createElement('a-entity');
  const pid = 'p'+Date.now();
  ent.setAttribute('id', pid);
  ent.setAttribute('gltf-model', lib.url);
  ent.setAttribute('position', `${refPos.x} ${refPos.y} ${refPos.z}`);
  ent.setAttribute('scale', '1 1 1');
  ent.setAttribute('gizmo', 'mode: translate; rotation: true; scale: true; size: 1.5');
  ent.setAttribute('class', 'placed clickable');
  ent.setAttribute('data-evidence','true');
  ent.setAttribute('data-valid', isValid);
  ent.setAttribute('draggable', 'true');
  ent.setAttribute('grabbable', 'true');
  ent.setAttribute('stretchable', 'true');
  ent.setAttribute('rotatable', 'true');
  ent.setAttribute('shadow', 'receive: true; cast: true');
  ent.setAttribute('raycastable', 'true');

  // âœ… ÙƒÙˆÙ„ÙŠØ¯Ø± ØºÙŠØ± Ù…Ø±Ø¦ÙŠ
  const collider = document.createElement('a-box');
  collider.setAttribute('position', '0 1 0');
  collider.setAttribute('width', '1');
  collider.setAttribute('height', '2');
  collider.setAttribute('depth', '0.5');
  collider.setAttribute('opacity', '0');
  collider.setAttribute('class', 'clickable');
  ent.appendChild(collider);

  scene.appendChild(ent);
  placed.push({id:pid,name:lib.name,el:ent});

  const option = document.createElement('option');
  option.value = pid;
  option.textContent = lib.name;
  placedSelector.appendChild(option);

  selectPlaced(pid);
}

/* Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
placedSelector.addEventListener('change', (e)=>{
  const id = e.target.value;
  selectPlaced(id);
  message.textContent = `ğŸ“Œ ØªÙ… ØªØ­Ø¯ÙŠØ¯: ${selected.name}`;
});

/* ØªØ­Ø¯ÙŠØ« Ù†ÙˆØ¹ Ø§Ù„Ø¯Ù„ÙŠÙ„ */
scene.addEventListener('click', (ev) => {
  const el = ev.target;
  const ent = el.closest ? el.closest('a-entity') : null;
  if (!ent) return;

  // âœ… Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
  if (timeLeft > 0 && ent.getAttribute('data-evidence') === 'true') {
    ent.setAttribute('data-evidence', 'collected');
    const valid = ent.getAttribute('data-valid');
    if (valid === 'true') { score += 10; }
    message.textContent = valid === 'true' ? 'âœ… Ø¯Ù„ÙŠÙ„ ØµØ­ÙŠØ­ ØªÙ… Ø¬Ù…Ø¹Ù‡' : 'âŒ Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø¯Ù„ÙŠÙ„Ù‹Ø§';
    updateScore();
    setTimeout(() => message.textContent = '', 2000);
  }

  // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
  const isPlaced = placed.find(p => p.el === ent);
  if (isPlaced) {
    selectPlaced(isPlaced.id);               // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    placedSelector.value = isPlaced.id;      // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    message.textContent = `ğŸ“Œ ØªÙ… ØªØ­Ø¯ÙŠØ¯: ${isPlaced.name}`;
  }
});




/* Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ */
function rotateSelected(axis){
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  const rot = selected.el.getAttribute('rotation');
  if(axis==='x') rot.x += 90;
  if(axis==='y') rot.y += 90;
  if(axis==='z') rot.z += 90;
  selected.el.setAttribute('rotation', `${rot.x} ${rot.y} ${rot.z}`);
}

function raiseSelected(){
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  const pos = selected.el.getAttribute('position');
  pos.y += 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}

function lowerSelected(){
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  const pos = selected.el.getAttribute('position');
  pos.y -= 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}

/* Ø£Ø²Ø±Ø§Ø± gizmo */
modeTranslate.addEventListener('click', () => {
  if (!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  selected.el.setAttribute('gizmo', 'mode: translate; size: 1.5');
});
modeRotate.addEventListener('click', () => {
  if (!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  selected.el.setAttribute('gizmo', 'mode: rotate; size: 1.5');
});
modeScale.addEventListener('click', () => {
  if (!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  selected.el.setAttribute('gizmo', 'mode: scale; size: 1.5');
});
confirmBtn.addEventListener('click', () => {
  if (!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  selected.el.removeAttribute('gizmo');
  message.textContent = 'âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
});
deleteBtn.addEventListener('click', ()=>{
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');

  // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…Ø³Ø±Ø­
  try { scene.removeChild(selected.el); } catch(e){}

  // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  const optionToRemove = [...placedSelector.options].find(opt => opt.value === selected.id);
  if(optionToRemove) placedSelector.removeChild(optionToRemove);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ©
  placed = placed.filter(p => p.id !== selected.id);

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ¯
  selected = null;
  message.textContent = 'ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„Ù…Ø³Ø±Ø­ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©';
});


/* Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
startBtn.addEventListener('click', ()=>{
  if(placed.length === 0) return alert('Ø¶Ø¹ Ø¹Ù†Ø§ØµØ± Ø£ÙˆÙ„Ø§Ù‹');

  score = 0;
  updateScore();
  timeLeft = parseInt(durationInput.value) || 120;
  updateTimerDisplay();

  placed.forEach(p => p.el.setAttribute('data-evidence', 'true'));

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      endRound();
    }
  }, 1000);

  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø«Ù… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
  message.textContent = 'â³ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯Ø£! Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù„Ø© Ù„Ø¬Ù…Ø¹Ù‡Ø§.';
  setTimeout(() => { message.textContent = ''; }, 3000);
});

stopBtn.addEventListener('click', ()=>{ 
  if(timerInterval) clearInterval(timerInterval); 
  message.textContent='â¹ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù.'; 
});
function updateTimerDisplay(){
  const mm = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const ss = (timeLeft%60).toString().padStart(2,'0');
  timerText.textContent = `${mm}:${ss}`;
}
function updateScore(){
  scorePanel.textContent = score;
  scoreHud.textContent = score;
}

function endRound(){
  message.textContent = `â± Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø·Ùƒ: ${score}`;
  placed.forEach(p => p.el.setAttribute('data-evidence','false'));
}

/* Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¯Ù„Ø© */
finalizeBtn.addEventListener('click', () => {
  let correct = 0;
  let wrong = 0;
  placed.forEach(p => {
    const status = p.el.getAttribute('data-evidence');
    const valid = p.el.getAttribute('data-valid');
    if (status === 'collected') {
      if (valid === 'true') {
        correct++;
      } else {
        wrong++;
      }
    }
  });

  message.textContent = `ğŸ“Š Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct} | Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${wrong}`;
  placed.forEach(p => {
    const valid = p.el.getAttribute('data-valid');
    const label = document.createElement('a-text');
    label.setAttribute('value', valid === 'true' ? 'âœ” Ø¯Ù„ÙŠÙ„ ØµØ­ÙŠØ­' : 'âœ– Ù„ÙŠØ³ Ø¯Ù„ÙŠÙ„Ù‹Ø§');
    label.setAttribute('color', valid === 'true' ? 'green' : 'red');
    label.setAttribute('position', '0 0.5 0');
    label.setAttribute('align', 'center');
    p.el.appendChild(label);
  });
});

/* Ø¯Ø§Ù„Ø© Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† HTML */
function escapeHtml(s){
  return (s||'').toString().replace(/[&<>"']/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  })[c]);
}

/* Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© */
function seedExamples(){
  const examples = [
    {name:'Ø³ÙƒÙŠÙ†', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/ReciprocatingSaw/glTF-Binary/ReciprocatingSaw.glb'},
    {name:'Ù…Ø³Ø¯Ø³', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF-Binary/Duck.glb'},
    {name:'Ø¨Ù‚Ø¹Ø© Ø¯Ù…', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Avocado/glTF-Binary/Avocado.glb'},
    {name:'Ù‡Ø§ØªÙ', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Box/glTF-Binary/Box.glb'},
    {name:'Ø­Ø§Ø¬Ø²', url:'https://dns3uae-glitch.github.io/crime-book-ai/fall-investigation-scene/source/nft_ipfs_gltf.gltf'},
    {name:'Ø¬Ø«Ø©', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb'}
  ];
  examples.forEach(x => {
    library.push({
      id: 'ex' + Math.random().toString(36).slice(2),
      name: x.name,
      url: x.url
    });
  });

  renderLibrary();
}
const savedLibrary = localStorage.getItem('evidenceLibrary');
if (savedLibrary) {
  library = JSON.parse(savedLibrary);
  renderLibrary();
} else {
  seedExamples(); // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…ÙƒØªØ¨Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø«Ù„Ø©
}
function moveSelected(direction){
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
  const pos = selected.el.getAttribute('position');
  if(direction === 'left') pos.x -= 0.5;
  if(direction === 'right') pos.x += 0.5;
  if(direction === 'forward') pos.z -= 0.5;
  if(direction === 'backward') pos.z += 0.5;
  selected.el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
}
function selectPlaced(id){
  if(selected && selected.id === id) return;
  selected = placed.find(p=>p.id===id);
  placed.forEach(p=> p.el.setAttribute('material','color','#fff'));
  if(selected){
    selected.el.setAttribute('material','color','#2ecc71');
    selected.el.setAttribute('gizmo', 'mode: translate; rotation: true; scale: true; size: 1.5');
  }
}

</script>
</body>
</html>
