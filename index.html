<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Builder: Ù…Ø³Ø±Ø­ Ø¬Ø±ÙŠÙ…Ø© Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ - ÙˆØ¶Ø¹ Ù†Ù…Ø§Ø°Ø¬ GLB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root { --bg:#0f1112; --panel:#131516; --accent:#c59e2b; --muted:#9aa0a6; color-scheme: dark; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#fff}
    #app{display:flex;height:100vh;gap:10px}
    #sidebar{width:360px;background:var(--panel);padding:12px;overflow:auto;border-right:1px solid rgba(255,255,255,0.04)}
    h2{margin:6px 0 12px 0;font-size:18px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], input[type="url"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0c0d0e;color:#fff}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#081217;cursor:pointer;margin-top:8px;font-weight:700}
    .small{background:#222;border-radius:8px;padding:6px 8px;margin-left:6px;font-size:13px;color:var(--muted)}
    .item{background:#0b0c0d;padding:8px;border-radius:8px;margin-top:8px;display:flex;gap:8px;align-items:center}
    .list{margin-top:10px}
    #sceneWrap{flex:1;position:relative}
    #hud{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:gold;z-index:2}
    #controls{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;z-index:2}
    #message{position:absolute;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:8px;z-index:2}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
    .list .row{display:flex;justify-content:space-between;align-items:center}
    .previewSmall{width:60px;height:45px;background:#080808;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#777}
    .selected{outline:2px solid #2ecc71}
    #timer{font-weight:900;color:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <h2>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± - Ø£Ø¶Ù Ù†Ù…ÙˆØ°Ø¬ GLB</h2>

      <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±</label>
      <input id="modelName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙŠÙ† (Knife)">

      <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù .glb / .gltf (Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±)</label>
      <input id="modelUrl" type="url" placeholder="https://.../model.glb">

      <div style="display:flex;gap:8px;">
        <button id="addBtn">â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button id="previewBtn" class="btn-ghost">ğŸ‘ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
      </div>
      <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø±Ø§Ø¨Ø· glb ØµØ§Ù„Ø­ - Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. (Ø£ÙØ¶Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù„Ù‰ GitHub/Glitch/Ù¾ÙˆÙ„ÙŠ Ø¨ÙŠØ²Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±ÙˆØ§Ø¨Ø· Raw Ù…Ù† GitHub)</div>

      <h2 style="margin-top:18px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±</h2>
      <div id="library" class="list"></div>

      <h2 style="margin-top:18px">ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± / ÙˆØ¶Ø¹Ù‡</h2>
      <div class="hint">Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ ÙÙŠ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ù‡.</div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button id="placeBtn" class="btn-ghost">ğŸ“ Ø¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button id="deleteBtn" class="btn-ghost">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±</button>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button id="moveUp" class="btn-ghost">â†‘</button>
        <button id="moveDown" class="btn-ghost">â†“</button>
        <button id="moveLeft" class="btn-ghost">â†</button>
        <button id="moveRight" class="btn-ghost">â†’</button>
      </div>

      <h2 style="margin-top:18px">Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
      <label>Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
      <input id="duration" type="text" value="120">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        <button id="stopBtn" class="btn-ghost">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>

      <div style="margin-top:12px">
        <strong>Ù†Ù‚Ø§Ø·:</strong> <span id="scorePanel">0</span>
      </div>

      <div style="margin-top:14px">
        <strong>Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©:</strong>
        <ul style="margin:6px 0 0 18px;color:var(--muted)">
          <li>Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ <span style="color:#8fbff0">Sketchfab</span> Ø£Ùˆ <span style="color:#8fbff0">Poly Haven</span> Ù„ØªØ­Ù…ÙŠÙ„ GLB.</li>
          <li>Ø£ÙØ¶Ù„ Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒ Ø¹Ù„Ù‰ GitHub ÙˆÙ†Ø³Ø® Ø±Ø§Ø¨Ø· raw Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… jsDelivr.</li>
          <li>Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø®Ø·Ø£ CORS Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©ØŒ Ø§Ø±ÙÙ‚ Ø§Ù„Ù…Ù„Ù ÙÙŠ GitHub/GDrive (Ù…ÙØªÙˆØ­) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Ø§Ø³ØªØ¶Ø§ÙØ©.</li>
        </ul>
      </div>

    </div>

    <div id="sceneWrap">
      <div id="hud">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
      <div id="controls">
        <div>Ø§Ù„ÙˆÙ‚Øª: <span id="timer">--:--</span></div>
        <div style="margin-top:8px"><button id="toggleGiz" class="btn-ghost">ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠÙƒ Ø¨Ø§Ù„ÙØ£Ø±Ø©</button></div>
      </div>
      <div id="message"></div>

      <!-- Ù…Ø´Ù‡Ø¯ A-Frame -->
      <a-scene id="scene" background="color: #111" embedded vr-mode-ui="enabled: false">
        <!-- Ø£Ø±Ø¶ÙŠØ© ÙˆØ³Ø¬Ø§Ø¯ -->
        <a-plane rotation="-90 0 0" width="10" height="10" color="#2b221f" repeat="4 4"></a-plane>

        <!-- Ø¬Ø¯Ø±Ø§Ù† Ø¨Ø³ÙŠØ·Ø© -->
        <a-box position="0 1.6 -5" width="10" height="3" depth="0.1" color="#3c2f2f"></a-box>
        <a-box position="-5 1.6 0" width="0.1" height="3" depth="10" color="#3f3333"></a-box>
        <a-box position="5 1.6 0" width="0.1" height="3" depth="10" color="#3f3333"></a-box>

        <!-- Ø¥Ø¶Ø§Ø¡Ø© -->
        <a-entity light="type: ambient; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="2 4 2"></a-entity>

        <!-- ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <a-entity id="cameraRig" position="0 1.6 3">
          <a-entity camera look-controls wasd-controls></a-entity>
        </a-entity>
      </a-scene>
    </div>
  </div>

<script>
/* ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====== */
const libraryEl = document.getElementById('library');
const addBtn = document.getElementById('addBtn');
const previewBtn = document.getElementById('previewBtn');
const modelNameInput = document.getElementById('modelName');
const modelUrlInput = document.getElementById('modelUrl');
const placeBtn = document.getElementById('placeBtn');
const deleteBtn = document.getElementById('deleteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const durationInput = document.getElementById('duration');
const scorePanel = document.getElementById('scorePanel');
const scoreHud = document.getElementById('score');
const message = document.getElementById('message');
const scene = document.getElementById('scene');
const timerText = document.getElementById('timer');
const toggleGiz = document.getElementById('toggleGiz');

let library = [];         // {id, name, url}
let placed = [];          // placed entities {id, name, el}
let selected = null;
let score = 0;
let timerInterval = null;
let timeLeft = 0;
let allowMoveByMouse = false;

/* ====== ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© ====== */
function renderLibrary(){
  libraryEl.innerHTML = '';
  library.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div style="flex:1">
        <div class="row"><strong>${escapeHtml(item.name)}</strong></div>
        <div style="font-size:12px;color:#8f999f;margin-top:6px">${escapeHtml(item.url)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost" data-id="${item.id}" onclick="previewModel('${item.url}')">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        <button class="btn-ghost" data-id="${item.id}" onclick="placeModel('${item.id}')">ÙˆØ¶Ø¹</button>
      </div>
    `;
    libraryEl.appendChild(div);
  });
}

addBtn.addEventListener('click', ()=>{
  const name = modelNameInput.value.trim() || 'Model';
  const url = modelUrlInput.value.trim();
  if(!url){
    alert('Ø¶Ø¹ Ø±Ø§Ø¨Ø· glb Ø£Ùˆ gltf ØµØ§Ù„Ø­');
    return;
  }
  const id = 'm'+Date.now();
  library.push({id,name,url});
  modelNameInput.value=''; modelUrlInput.value='';
  renderLibrary();
});

/* ====== Ù…Ø¹Ø§ÙŠÙ†Ø© (ØªØ¶Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¶ ØµØºÙŠØ±) ====== */
window.previewModel = function(url){
  // Ù†Ø¶ÙŠÙ ÙƒÙŠØ§Ù† Ù…Ø¤Ù‚Øª ÙÙŠ Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø´Ù‡Ø¯ØŒ Ø«Ù… Ù†Ø²ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†ÙŠ
  const tempId = 'preview-'+Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', tempId);
  ent.setAttribute('gltf-model', url);
  ent.setAttribute('position', '0 1 -1');
  ent.setAttribute('scale','0.6 0.6 0.6');
  scene.appendChild(ent);
  message.textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø©: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...';
  setTimeout(()=>{ message.textContent=''; try{ scene.removeChild(ent);}catch(e){} },6000);
}

/* ====== ÙˆØ¶Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====== */
window.placeModel = function(libId){
  const lib = library.find(l=>l.id===libId);
  if(!lib) return;
  const ent = document.createElement('a-entity');
  const pid = 'p'+Date.now();
  ent.setAttribute('id', pid);
  ent.setAttribute('gltf-model', lib.url);
  // Ù†Ø¶Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù…Ø³Ø§ÙØ© Ø«Ø§Ø¨ØªØ©
  const cam = document.querySelector('[camera]').parentElement;
  const camPos = cam.getAttribute('position');
  // Ù†Ø¶Ø¹Ù‡ Ø£Ù…Ø§Ù… Ø¨Ù…Ù‚Ø¯Ø§Ø± 1.5 Ù…ØªØ±
  ent.setAttribute('position', `${camPos.x} ${camPos.y-0.5} ${camPos.z-1.5}`);
  ent.setAttribute('scale', '0.7 0.7 0.7');
  ent.setAttribute('class', 'placed clickable');
  // Ù†Ø¬Ø¹Ù„ ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø§Ø¨Ù„ Ù„Ø£Ù† ÙŠÙƒÙˆÙ† Ø¯Ù„ÙŠÙ„ evidence Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹
  ent.setAttribute('data-evidence','true');
  scene.appendChild(ent);
  placed.push({id:pid,name:lib.name,el:ent});
  selectPlaced(pid);
}

/* ====== Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ± Ù…ÙˆØ¶ÙˆØ¹ (select) ====== */
function selectPlaced(id){
  // Ù†Ø¹Ù„Ù… Ø§Ù„ÙƒÙŠØ§Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¨Ø­Ø¯ Ø¨ØµØ±ÙŠ
  selected = placed.find(p=>p.id===id);
  // Ø¥Ø²Ø§Ù„Ø© ØªÙ…ÙŠÙŠØ² Ù…Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹
  placed.forEach(p=>{ p.el.classList.remove('selected'); });
  if(selected){
    selected.el.classList.add('selected');
  }
}

/* Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø± */
deleteBtn.addEventListener('click', ()=>{
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…Ø´Ù‡Ø¯.');
  try{ scene.removeChild(selected.el); }catch(e){}
  placed = placed.filter(p=>p.id!==selected.id);
  selected=null;
});

/* ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø²Ø± Ù…Ù†ÙØµÙ„ */
placeBtn.addEventListener('click', ()=>{
  // Ù†Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„ÙˆØ¶Ø¹Ù‡ ÙƒÙ…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹
  if(library.length===0) return alert('Ø£Ø¶Ù Ù†Ù…ÙˆØ°Ø¬Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©.');
  placeModel(library[library.length-1].id);
});

/* ====== ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© (Ù…Ø±Ø¨Ø¹Ø§Øª 0.1m) ====== */
document.getElementById('moveUp').addEventListener('click', ()=>moveSelected(0,0,-0.1));
document.getElementById('moveDown').addEventListener('click', ()=>moveSelected(0,0,0.1));
document.getElementById('moveLeft').addEventListener('click', ()=>moveSelected(-0.1,0,0));
document.getElementById('moveRight').addEventListener('click', ()=>moveSelected(0.1,0,0));

function moveSelected(dx,dy,dz){
  if(!selected) return alert('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ø£ÙˆÙ„Ø§');
  const pos = selected.el.getAttribute('position');
  selected.el.setAttribute('position', {x: pos.x+dx, y: pos.y+dy, z: pos.z+dz});
}

/* ====== ØªÙØ¹ÙŠÙ„ Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ (Ø¨Ø³ÙŠØ·): Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ØŒ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ÙŠØ¬Ø¹Ù„Ù‡ ÙŠØªØ­Ø±Ùƒ Ù…Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ */
toggleGiz.addEventListener('click', ()=>{
  allowMoveByMouse = !allowMoveByMouse;
  toggleGiz.textContent = allowMoveByMouse ? 'Ø¥ÙŠÙ‚Ø§Ù ØªØ­Ø±ÙŠÙƒ Ø¨Ø§Ù„ÙØ£Ø±Ø©' : 'ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠÙƒ Ø¨Ø§Ù„ÙØ£Ø±Ø©';
});

/* Ù†Ø³Ù…Ø¹ Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ø£Ùˆ Ø¬Ù…Ø¹ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
scene.addEventListener('click', (ev)=>{
  // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† glTF ÙØ³ÙŠØªØ¶Ù…Ù† ev.target.closestEntity
  const target = ev.target;
  // Ø£ÙŠ ÙƒÙŠØ§Ù† Ù…ÙˆØ¶ÙˆØ¹ (placed) ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø±Ù‡
  const ent = target.closest ? target.closest('a-entity') : null;
  if(!ent) return;
  // Ø¥Ø°Ø§ ÙŠØ³Ù…Ø­ Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø¨Ø§Ù„ÙØ£Ø±Ø© ÙˆÙ†Ø®ØªØ§Ø± Ø¹Ù†ØµØ±Ù‹Ø§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const pid = ent.getAttribute('id');
  const placedItem = placed.find(p=>p.id===pid);
  if(placedItem){
    selectPlaced(pid);
    if(allowMoveByMouse){
      // ÙˆØ¶Ø¹ Ø¹Ù†ØµØ± Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙƒØ·Ø±ÙŠÙ‚Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù†Ù‚Ù„ (Ø¨Ø³Ø§Ø·Ø©)
      const cam = document.querySelector('[camera]').parentElement;
      const camPos = cam.getAttribute('position');
      ent.setAttribute('position', `${camPos.x} ${camPos.y-0.8} ${camPos.z-1.2}`);
    }
  }
});

/* ====== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù„Ø© ====== */
startBtn.addEventListener('click', ()=>{
  // Ù†Ø¶Ø¹ ÙƒÙ„ placed entities ÙƒØ¯Ù„Ø§Ø¦Ù„ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¬Ù…Ø¹ (ÙØªØ±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  if(placed.length===0) return alert('Ø¶Ø¹ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹');
  score = 0; updateScore();
  timeLeft = parseInt(durationInput.value) || 120;
  updateTimerDisplay();
  // Ø§Ø¶Ù ØµÙ†Ù evidence Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ù‚Ø§Ø¨Ù„Ù‹Ø§ Ù„Ù„Ù†Ù‚Ø± Ù„Ø¬Ù…Ø¹Ù‡
  placed.forEach(p=> p.el.setAttribute('data-evidence','true'));
  // Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      endRound();
    }
  },1000);
  message.textContent = 'â³ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯Ø£! Ø­Ø§ÙˆÙ„ Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù„Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ±.';
});

stopBtn.addEventListener('click', ()=>{ if(timerInterval) clearInterval(timerInterval); message.textContent='â¹ ØªÙˆÙ‚Ù.'; });

function updateTimerDisplay(){
  const mm = Math.floor(timeLeft/60).toString().padStart(2,'0');
  const ss = (timeLeft%60).toString().padStart(2,'0');
  timerText.textContent = `${mm}:${ss}`;
}

/* Ø­Ø¯Ø« Ø¬Ù…Ø¹ Ø§Ù„Ø¯Ù„Ø§Ø¦Ù„: Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ù…ÙˆØ¶ÙˆØ¹ ÙŠØ¬Ù…Ø¹Ù‡ ÙˆÙŠØ²ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· */
scene.addEventListener('click', (ev)=>{
  if(timeLeft<=0) return;
  const el = ev.target;
  // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‡Ù„: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† a-entity ÙŠØ­Ù…Ù„ data-evidence="true"
  const ent = el.closest ? el.closest('a-entity') : null;
  if(!ent) return;
  if(ent.getAttribute('data-evidence') === 'true'){
    // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¯Ù„ÙŠÙ„
    ent.setAttribute('data-evidence','collected');
    // Ù…Ø¤Ø«Ø± Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ·: ØªØµØºÙŠØ± ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù„ÙˆÙ†
    try{
      ent.setAttribute('animation','property: scale; to: 0.4 0.4 0.4; dur:400');
      ent.setAttribute('material','color','#00ff88');
    }catch(e){}
    score += 10;
    updateScore();
    message.textContent = `âœ… Ø¬Ù…Ø¹ Ø§Ù„Ø¯Ù„ÙŠÙ„: ${ent.getAttribute('id') || 'Ø¹Ù†ØµØ±'}`;
    setTimeout(()=>message.textContent='',2000);
  }
});

function updateScore(){ scorePanel.textContent = score; scoreHud.textContent = score; }

function endRound(){
  message.textContent = `â± Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø·Ùƒ: ${score}`;
  // Ø¥Ù„ØºØ§Ø¡ Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¬Ù…Ø¹
  placed.forEach(p=> p.el.setAttribute('data-evidence','false'));
}

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙØ±ÙŠØº Ù…Ø«Ø§Ù„ Ø¨Ø¹Ù†Ø§ØµØ± Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ù‡Ø²Ø© (Ø±ÙˆØ§Ø¨Ø· Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±) ====== */
(function seedExamples(){
  const examples = [
    {name:'Ø²Ø¬Ø§Ø¬Ø© ØªØ¬Ø±Ø¨Ø© (Ø§Ø®ØªØ¨Ø§Ø±)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/WaterBottle/glTF/WaterBottle.gltf'},
    {name:'Ø§ÙÙˆÙƒØ§Ø¯Ùˆ (Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø¬Ù…/Ù…ÙˆØ§Ø¯)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Avocado/glTF/Avocado.gltf'},
    {name:'Duck (Ù…ÙˆØ¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±)', url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Duck/glTF/Duck.gltf'}
  ];
  examples.forEach(x=> library.push({id:'ex'+Math.random().toString(36).slice(2), name:x.name, url:x.url}));
  renderLibrary();
})();

/* ====== Helpers ====== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

</script>
</body>
</html>
