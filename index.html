<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>AI Crime Scene â€“ Elite Investigator Edition (v9-fixed+smooth)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
:root{--gold:#d4af37;--dark:#0a0c0f;--glass:#0f1317cc}
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:var(--dark);font-family:"Tajawal",system-ui,Arial;color:#fff}
a-scene{width:100%;height:100vh;z-index:1}

/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
#overlayStart{
  position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(700px 420px at 50% 40%, rgba(212,175,55,.15), rgba(0,0,0,.8));
  z-index:12000;text-align:center;color:var(--gold);font-size:22px
}
#overlayStart, #overlayStart *{ pointer-events:auto !important; }
#overlayStart button{
  margin-top:20px;padding:10px 24px;border:none;border-radius:12px;cursor:pointer;
  background:linear-gradient(90deg,var(--gold),#b78f2a);color:#000;font-weight:800;font-size:18px;
  box-shadow:0 0 14px rgba(212,175,55,.5); transition:transform .18s ease, box-shadow .18s ease, filter .2s ease
}
#overlayStart button:hover{ box-shadow:0 0 26px rgba(212,175,55,.85); filter:brightness(1.05) }
#overlayStart button:active{ transform:scale(.96) }

/* HUD */
#hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 12px;font-weight:800;z-index:11000;display:flex;gap:10px;align-items:center}
#time{color:#d4af37}
#status{color:#cfe1ff}
#score{color:#39d98a}

/* Ø·Ø¨Ù‚Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
#uiLayer{position:fixed;inset:0;z-index:10000;pointer-events:none}
#btnOpen{position:absolute;top:20px;right:20px;pointer-events:auto;width:56px;height:56px;border:none;border-radius:50%;cursor:pointer;background:radial-gradient(circle at 35% 30%, var(--gold), #b78f2a);color:#000;font-weight:900;font-size:22px;box-shadow:0 0 12px rgba(212,175,55,.6)}

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
#sidebar{position:absolute;top:0;right:0;width:400px;height:100%;background:var(--glass);backdrop-filter:blur(14px);border-left:1px solid rgba(255,255,255,.12);padding:14px;overflow:auto;transition:right .45s ease;pointer-events:auto;z-index:10001}
#sidebar.hidden{right:-420px}
#sidebarHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#btnClose{pointer-events:auto;border:none;background:transparent;color:#fff;font-size:20px;cursor:pointer}
h2{color:var(--gold);margin:12px 0 8px}
.btn{background:linear-gradient(90deg,var(--gold),#b78f2a);color:#000;font-weight:800;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 0 12px rgba(212,175,55,.4)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#d6dbe3;border-radius:10px;padding:7px 10px;cursor:pointer}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1014;color:#fff}
.library{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.card{background:rgba(255,255,255,.05);border-radius:12px;padding:10px;text-align:center;box-shadow:inset 0 0 14px rgba(212,175,55,.12);transition:.25s;cursor:pointer}
.card:hover{box-shadow:0 0 20px rgba(212,175,55,.28)}
.card .btn{width:100%;margin-top:6px}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù…Ø© */
.dynamic-controls, .camera-controls {
  position: fixed;
  bottom: 20px;
  background: rgba(0,0,0,0.6);
  border-radius: 12px;
  padding: 10px;
  display: flex;
  gap: 6px;
  z-index: 10002;
}

/* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªØ¨Ù‚Ù‰ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© */
.dynamic-controls {
  left: 20px;
  flex-direction: column;
}

/* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØµÙ Ø¨Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© */
.camera-controls {
  left: 50%;
  transform: translateX(-50%);
  flex-direction: row; /* Ø¬Ø¹Ù„Ù‡Ø§ Ø£ÙÙ‚ÙŠØ© */
  justify-content: center;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù†ÙØ³Ù‡Ø§ Ù„Ø§ ØªØºÙŠÙ‘Ø± */
.dynamic-controls .row, .camera-controls .row {
  display: flex;
  gap: 6px;
  justify-content: center;
}

.ctrl-btn, .cam-btn {
  background: var(--gold);
  border: none;
  border-radius: 8px;
  font-size: 18px;
  font-weight: bold;
  color: #000;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 6px rgba(212,175,55,.4);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.ctrl-btn:hover, .cam-btn:hover {
  transform: scale(1.1);
}


/* Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© */
#noteModal {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  z-index: 12001;
  background: radial-gradient(600px 320px at 50% 40%, rgba(212,175,55,.12), rgba(0,0,0,.65));
}
.noteCard {
  width: min(92vw,520px);
  background: #0b0f13f2;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 0 22px rgba(212,175,55,.35);
}
.noteCard .row { justify-content: flex-end; }

/* Toast */
.toast {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.75);
  padding: 10px 14px;
  border-radius: 10px;
  display: none;
  z-index: 11000;
}

/* === Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡ === */
@media (max-width: 768px) {
  .dynamic-controls, .camera-controls {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(10, 12, 15, 0.85);
    padding: 8px 10px;
    border-radius: 14px;
    box-shadow: 0 0 10px rgba(212,175,55,0.25);
  }

  .dynamic-controls {
    bottom: 110px; /* ÙÙˆÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 92vw;
  }

  .camera-controls {
    bottom: 20px;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 92vw;
  }

  .ctrl-btn, .cam-btn {
    width: 38px;
    height: 38px;
    font-size: 16px;
  }
}

/* ğŸ’» Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© */
@media (min-width: 769px) and (max-width: 1200px) {
  .dynamic-controls, .camera-controls {
    transform: none;
    left: auto;
    right: 20px;
    background: rgba(10,12,15,0.65);
  }
}

/* ===== Ø¯Ø¹Ù… Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªØ§Ø¨Ù„Øª ===== */

/* ğŸ“± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Portrait) */
@media (orientation: portrait) {
  .dynamic-controls {
    bottom: 110px;
    left: 50%;
    transform: translateX(-50%);
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    width: 92vw;
  }
  .camera-controls {
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    width: 92vw;
  }
  #sidebar {
    width: 100%;
    height: 50%;
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: 1px solid rgba(255,255,255,.12);
    border-radius: 12px 12px 0 0;
  }
}

/* ğŸ’» Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ (Landscape) */
@media (orientation: landscape) {
  .dynamic-controls {
    bottom: 20px;
    left: 20px;
    flex-direction: column;
    gap: 6px;
    transform: none;
  }
  .camera-controls {
    right: 20px;
    left: auto;
    bottom: 20px;
    transform: none;
    flex-direction: column;
    gap: 6px;
  }
  #sidebar {
    width: 380px;
    height: 100%;
    top: 0;
    right: 0;
    border-left: 1px solid rgba(255,255,255,.12);
    border-top: none;
    border-radius: 0;
  }
}

/* fallback Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ */
@media (max-width: 600px) {
  .ctrl-btn, .cam-btn { width: 34px; height: 34px; font-size: 15px; }
}
/* ğŸ¯ ØªØ­Ø³ÙŠÙ† Ø®Ø§Øµ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„ØªØ¬Ù†Ø¨ ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø´Ù‡Ø¯ */
@media (orientation: landscape) and (max-height: 500px) {
  .dynamic-controls, .camera-controls {
    background: rgba(10,10,10,0.45); /* Ø´ÙØ§ÙÙŠØ© Ø£ÙƒØ¨Ø± */
    padding: 6px;
    border-radius: 10px;
    flex-direction: row; /* ØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
    flex-wrap: nowrap;
    justify-content: center;
    gap: 4px;
    width: 96vw;
    left: 50%;
    transform: translateX(-50%);
  }

  .dynamic-controls {
    bottom: 60px; /* ØªØ±ÙØ¹Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙˆÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
  }

  .camera-controls {
    bottom: 10px; /* ØªØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
  }

  .ctrl-btn, .cam-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
    opacity: 0.85;
  }

  #sidebar {
    width: 320px;
    background: rgba(15,15,15,0.9);
  }
}
/* ğŸ¯ Ø­Ù„ Ø¬Ø°Ø±ÙŠ Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ¯Ø§Ø®Ù„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */

/* ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„ØªØ§Ø¨Ù„Øª â€” Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
@media (max-width: 768px) {
  .dynamic-controls, .camera-controls {
    max-width: 92vw;
    left: 50%;
    transform: translateX(-50%);
    overflow-x: auto;
    justify-content: center;
  }
  .dynamic-controls::-webkit-scrollbar,
  .camera-controls::-webkit-scrollbar {
    display: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  }
}

/* ÙÙŠ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨ â€” ØªØ¬Ù†Ù‘Ø¨ ØªØºØ·ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ */
@media (min-width: 1024px) {
  .dynamic-controls {
    left: 20px;
    bottom: 20px;
  }
  .camera-controls {
    left: calc(50% - 200px); /* Ù†Ù‚Ù„Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ù„ÙŠØ³Ø§Ø± Ù„ØªØ¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    bottom: 20px;
  }

  /* Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø© */
  #sidebar:not(.hidden) ~ .camera-controls {
    left: 45%; /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ¨ØªØ¹Ø¯ Ø£ÙƒØ«Ø± */
  }
  #sidebar:not(.hidden) ~ .dynamic-controls {
    left: 10%; /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªØ¨ØªØ¹Ø¯ Ø£ÙƒØ«Ø± */
  }
}

</style>
</head>
<body>

<!-- Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø§Ù„ØµÙˆØª + Ø²Ø± ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ -->
<div id="overlayStart">
  <div>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©<br>Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</div>
  <button id="btnStart" onclick="startApp()">Ø§Ø¨Ø¯Ø£</button>
</div>

<!-- HUD -->
<div id="hud">
  â± <span id="time">--:--</span> | <span id="status">Ø¬Ø§Ù‡Ø²</span> | ğŸ§® <span id="score">0</span>
</div>

<!-- Ø§Ù„Ù…Ø´Ù‡Ø¯ -->
<a-scene embedded renderer="antialias:true; colorManagement:true" touch-action="pan-y">
  <!-- Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯Ø±Ø§Ù† ÙƒÙ…Ø§ Ù‡ÙŠ -->
  <a-plane id="floor" rotation="-90 0 0" width="30" height="30"
           material="src: url(https://cdn.polyhaven.com/asset_img/primary/long_white_tiles.png?height=760&quality=95); repeat: 6 6;"
           class="clickable"></a-plane>
  <a-box class="clickable" position="0 3 -15" width="30" height="6" depth="0.12"
         material="src: url(https://cdn.polyhaven.com/asset_img/primary/red_brick.png?height=760&quality=95?auto=format&fit=crop&w=800&q=80); repeat: 3 1;"></a-box>
  <a-box class="clickable" position="0 3 15" width="30" height="6" depth="0.12"
         material="src: url(https://cdn.polyhaven.com/asset_img/primary/red_brick.png?height=760&quality=95?auto=format&fit=crop&w=800&q=80); repeat: 3 1;"></a-box>
  <a-box class="clickable" position="-15 3 0" width="0.12" height="6" depth="30"
         material="src: url(https://cdn.polyhaven.com/asset_img/primary/red_brick.png?height=760&quality=95?auto=format&fit=crop&w=800&q=80); repeat: 1 3;"></a-box>
  <a-box class="clickable" position="15 3 0" width="0.12" height="6" depth="30"
         material="src: url(https://cdn.polyhaven.com/asset_img/primary/red_brick.png?height=760&quality=95?auto=format&fit=crop&w=800&q=80); repeat: 1 3;"></a-box>
  <a-plane rotation="90 0 0" position="0 6 0" width="30" height="30"
           material="src: url(https://cdn.polyhaven.com/asset_img/primary/painted_plaster_wall.png?height=760&quality=95?auto=format&fit=crop&w=800&q=80); repeat: 6 6;"
           class="clickable"></a-plane>

  <a-entity light="type:ambient; intensity:0.55"></a-entity>
  <a-entity light="type:point; intensity:0.85; color:#d4af37" position="0 3 0"></a-entity>

  <a-entity id="rig" position="0 1.6 6"><a-entity camera look-controls wasd-controls="acceleration:30"></a-entity></a-entity>
  <a-entity id="ray" cursor="rayOrigin:mouse" raycaster="objects:.clickable,.placed,.noteMarker"></a-entity>
</a-scene>

<!-- ÙˆØ§Ø¬Ù‡Ø© -->
<div id="uiLayer">
  <button id="btnOpen">â‰¡</button>
  <aside id="sidebar" class="hidden">
    <div id="sidebarHead">
      <div style="color:#d4af37;font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <button id="btnClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© -->
    <h2>ğŸ“¦ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
    <div id="library" class="library"></div>

    <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø®Ø§Ø±Ø¬ÙŠ</h2>
    <div class="row">
      <input id="customName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±">
      <input id="customURL" type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (.glb)">
      <button class="btn" id="btnAddCustom">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <h2>ğŸ§© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø©</h2>
    <select id="placedList" size="6" style="width:100%"></select>
    <div class="row">
      <button class="btn-ghost" id="btnDelete">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±</button>
      <button class="btn-ghost" id="btnReset">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯</button>
    </div>

    <h2>âœ…âŒ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
    <div class="row">
      <select id="evidenceSel">
        <option value="none" selected>â€” Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ… â€”</option>
        <option value="true">âœ”ï¸ Ø¯Ù„ÙŠÙ„ ØµØ­ÙŠØ­</option>
        <option value="false">âŒ Ø¯Ù„ÙŠÙ„ Ø®Ø§Ø·Ø¦</option>
      </select>
      <button class="btn" id="btnApplyEvidence">ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <h2>ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
    <div class="row">
      <input id="duration" type="number" value="120" title="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ">
      <button class="btn" id="btnGameStart">Ø¨Ø¯Ø¡</button>
      <button class="btn-ghost" id="btnGameStop">Ø¥ÙŠÙ‚Ø§Ù</button>
      <button class="btn-ghost" id="btnGameFinalize">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
    </div>

<h2>ğŸ—’ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
<div class="row">
  <button class="btn" id="btnNoteMode">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
  <button class="btn-ghost" onclick="deleteNotes()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
</div>

    <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø±ÙŠÙƒ</h2>
    <div class="row">
      <label style="font-size:12px;color:#cdd6e1">Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ©:</label>
      <select id="stepSel">
        <option value="0.05">Ø¨Ø·ÙŠØ¦Ø© (0.05)</option>
        <option value="0.1" selected>Ù…ØªÙˆØ³Ø·Ø© (0.1)</option>
        <option value="0.25">Ø³Ø±ÙŠØ¹Ø© (0.25)</option>
        <option value="0.5">Ø¹Ø§Ù„ÙŠØ© (0.5)</option>
      </select>
    </div>
  </aside>
</div>

<!-- ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù†ØµØ± (ÙŠØ³Ø§Ø±) -->
<div id="controls" class="dynamic-controls">
  <div class="row">
    <button class="ctrl-btn" data-act="up">â¬†ï¸</button>
    <button class="ctrl-btn" data-act="down">â¬‡ï¸</button>
  </div>
  <div class="row">
    <button class="ctrl-btn" data-act="left">â¬…ï¸</button>
    <button class="ctrl-btn" data-act="right">â¡ï¸</button>
  </div>
  <div class="row">
    <button class="ctrl-btn" data-act="zoomIn">ğŸ”¼</button>
    <button class="ctrl-btn" data-act="zoomOut">ğŸ”½</button>
  </div>
  <div class="row">
    <button class="ctrl-btn" data-act="rotL">âŸ²</button>
    <button class="ctrl-btn" data-act="rotR">âŸ³</button>
  </div>
  <div class="row">
    <button class="ctrl-btn" data-act="tilt">ğŸ“</button>
    <!-- Ø¯Ù…Ø¬ ØªØµØºÙŠØ± Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø¹ Ø§Ù„Ø²ÙˆÙ… Ø£ÙˆØª (Ù†ÙØ³ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ) -->
    <button class="ctrl-btn" data-act="shrink">ğŸ”¹</button>
  </div>
  <div class="row">
    <button class="ctrl-btn" data-act="grow">â•</button>
  </div>
</div>

<!-- ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ÙŠÙ…ÙŠÙ†) -->
<!-- ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù…Ù†ØªØµÙ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø´ÙƒÙ„ Ø£ÙÙ‚ÙŠ) -->
<div id="cameraPanel" class="camera-controls">
  <button class="cam-btn" data-cam="up">â¬†ï¸</button>
  <button class="cam-btn" data-cam="down">â¬‡ï¸</button>
  <button class="cam-btn" data-cam="left">â¬…ï¸</button>
  <button class="cam-btn" data-cam="right">â¡ï¸</button>
  <button class="cam-btn" data-cam="fwd">ğŸ”¼</button>
  <button class="cam-btn" data-cam="back">ğŸ”½</button>
  <button class="cam-btn" data-cam="yawL">âŸ²</button>
  <button class="cam-btn" data-cam="yawR">âŸ³</button>
</div>

</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© -->
<div id="noteModal">
  <div class="noteCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <strong style="color:#d4af37">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</strong>
      <button class="btn-ghost" id="noteCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <label>Ø§Ù„Ù†Øµ:</label>
    <textarea id="noteText" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·..."></textarea>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="noteSave">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===== */
window.startApp = function(){
  const ov = document.getElementById('overlayStart');
  if(ov){ ov.style.transition='opacity .6s ease'; ov.style.opacity='0'; setTimeout(()=> ov.remove(),650); }
  try{
    if('speechSynthesis' in window){
      const u=new SpeechSynthesisUtterance('Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©');
      u.lang='ar'; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
  }catch(e){}
};

const sidebar = document.getElementById('sidebar');
document.getElementById('btnOpen').onclick  = ()=> sidebar.classList.remove('hidden');
document.getElementById('btnClose').onclick = ()=> sidebar.classList.add('hidden');

const toast = document.getElementById('toast');
function msg(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1100); }
const timeEl = document.getElementById('time');
const statusEl = document.getElementById('status');
const scoreEl = document.getElementById('score');

const scene = document.querySelector('a-scene');
const ray   = document.getElementById('ray');

/* ========== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ù„Ø³ ========== */
function lerp(a,b,t){ return a + (b-a)*t; }
function animate(duration, step, done){
  const start = performance.now();
  function frame(now){
    const p = Math.min(1, (now - start) / duration);
    step(p);
    if(p < 1) requestAnimationFrame(frame); else if(done) done();
  }
  requestAnimationFrame(frame);
}
function getVec3(attr){ return {x:attr.x||0,y:attr.y||0,z:attr.z||0}; }

function tweenPosition(ent, to, duration=200){
  const from = getVec3(ent.getAttribute('position')||{x:0,y:0,z:0});
  animate(duration, p=>{
    ent.setAttribute('position', {x:lerp(from.x,to.x,p), y:lerp(from.y,to.y,p), z:lerp(from.z,to.z,p)});
  });
}
function tweenDeltaPosition(ent, dx,dy,dz, duration=200){
  const from = getVec3(ent.getAttribute('position')||{x:0,y:0,z:0});
  tweenPosition(ent, {x:from.x+dx,y:from.y+dy,z:from.z+dz}, duration);
}
function tweenRotationY(ent, deltaDeg, duration=200){
  const from = ent.getAttribute('rotation') || {x:0,y:0,z:0};
  const toY = from.y + deltaDeg;
  animate(duration, p=>{
    ent.setAttribute('rotation', {x:from.x,y:lerp(from.y,toY,p),z:from.z});
  });
}
function tweenScaleFactor(ent, factor, duration=200){
  const s = ent.getAttribute('scale') || {x:1,y:1,z:1};
  const to = {x:s.x*factor, y:s.y*factor, z:s.z*factor};
  animate(duration, p=>{
    ent.setAttribute('scale',{x:lerp(s.x,to.x,p), y:lerp(s.y,to.y,p), z:lerp(s.z,to.z,p)});
  });
}

/* Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© */
const library = [
  {name:'Ø³Ù„Ø§Ø­ ÙƒÙ„Ø§Ø´Ù†ÙƒÙˆÙ', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/gun.glb'},
  {name:'Ù‚ÙŠØ¯ Ø­Ø¯ÙŠØ¯ÙŠ',     url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/scene_compressed.glb'},
  {name:'Ø³Ø±ÙŠØ±',          url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/bed.glb'},
  {name:'Ø¨Ù‚Ø¹Ø© Ø¯Ù…',       url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/blood.glb'},
  {name:'Ù…Ø³Ø¯Ø³',          url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/gun1.glb'},
  {name:'Ø³ÙŠÙ',           url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/siaf.glb'}
];
function renderLibrary(){
  const lib = document.getElementById('library'); lib.innerHTML = '';
  library.forEach((m,i)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="font-weight:800">${m.name}</div><button class="btn">ÙˆØ¶Ø¹</button>`;
    card.querySelector('button').onclick = ()=> placeModel(i);
    lib.appendChild(card);
  });
}
renderLibrary();
document.getElementById('btnAddCustom').onclick = ()=>{
  const name = document.getElementById('customName').value.trim();
  const url  = document.getElementById('customURL').value.trim();
  if(!name || !url){ msg('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø·'); return; }
  library.push({name, url}); renderLibrary(); msg('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©');
};

let placed = []; // {id,name,el,scored:false}
let selected = null;
const placedList = document.getElementById('placedList');
const evidenceSel = document.getElementById('evidenceSel');
document.getElementById('btnApplyEvidence').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }

  const val = evidenceSel.value;
  selected.setAttribute('data-valid', val);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  [...selected.children].filter(c=> c.classList && c.classList.contains('evidenceHalo')).forEach(h=>selected.removeChild(h));

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  if(val==='true' || val==='false'){
    const halo = document.createElement('a-torus');
    halo.classList.add('evidenceHalo');
    halo.setAttribute('radius','0.6'); halo.setAttribute('radius-tubular','0.02');
    halo.setAttribute('rotation','90 0 0'); halo.setAttribute('position','0 0.05 0');
    const col = (val==='true') ? '#39d98a' : '#ff5c5c';
    halo.setAttribute('material',`color:${col}; emissive:${col}; emissiveIntensity:0.5; opacity:0.85; transparent:true`);
    selected.appendChild(halo);
  }



  msg('âœ… ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù†ØµØ±');
  saveScene();
};


/* ========================
   ğŸ§© ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„ØºØ±ÙØ© Ø¨Ø­Ø¬Ù… Ø°ÙƒÙŠ
   ======================== */
/* ========================
/* ========================
   ğŸ§© ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ© Ø¨Ø¯Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© + ØªØµØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ
   ======================== */
function placeModel(i){
  const m = library[i];
  if(!m) return;

  const id = 'ent-' + Date.now();
  const ent = document.createElement('a-entity');
  ent.setAttribute('id', id);
  ent.setAttribute('gltf-model', m.url);
  ent.classList.add('placed', 'clickable');
  ent.setAttribute('data-valid', 'none');
  ent.setAttribute('data-scored', 'no');

  // Ù…ÙˆØ¶Ø¹ Ù…Ø¨Ø¯Ø¦ÙŠ (Ù†ÙØ³ Ù…ÙƒØ§Ù† Ø§Ù„Ø³Ø±ÙŠØ± / Ù…Ù†ØªØµÙ Ø§Ù„ØºØ±ÙØ© Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
  // Ø³Ù†Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø¯Ù‚Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  ent.setAttribute('position', '0 0 -2.8');
  ent.setAttribute('rotation', '0 180 0');

  // Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù€Bounding Box ÙˆÙ†Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹
  ent.addEventListener('model-loaded', (e)=>{
    const THREE = (window.AFRAME && AFRAME.THREE) ? AFRAME.THREE : window.THREE;
    if(!THREE) { console.warn('THREE ØºÙŠØ± Ù…ØªØ§Ø­'); return; }

    // Ø¬Ø°Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù€GLTF Ø§Ù„Ù…Ø­Ù…Ù„
    const root = e.detail.model || ent.getObject3D('mesh');
    if(!root){ console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø°Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬'); return; }

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ­Ø¬ÙŠÙ…
    const bbox = new THREE.Box3().setFromObject(root);
    const size = bbox.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    // ğŸ‘‡ ØªØµØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù†Ø¬Ø¹Ù„ Ø£ÙƒØ¨Ø± Ø¨ÙØ¹Ø¯ â‰ˆ 1 Ù…ØªØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ØŒ ÙˆÙ„Ø§ Ù†ÙƒØ¨Ù‘Ø± Ù†Ù…Ø§Ø°Ø¬ ØµØºÙŠØ±Ø©
    // ÙˆÙ†Ø¶Ø¹ Ø³Ù‚ÙÙ‹Ø§ Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø­Ø¬Ù… (0.35) Ø­ØªÙ‰ ØªØ¸Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØµØºÙŠØ±Ø© Ù†Ø³Ø¨ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ©
    let s = Math.min(0.35, 1.0 / (maxDim || 1)); // Ù„Ùˆ maxDim ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ => s ØµØºÙŠØ±
    if(!isFinite(s) || s <= 0) s = 0.2;          // Ø§Ø­ØªÙŠØ§Ø·

    // Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙŠØ§Ù† (Ù…ÙˆØ­Ù‘Ø¯)
    ent.setAttribute('scale', `${s} ${s} ${s}`);

    // Ù†Ø­Ø³Ø¨ Ø£Ø¯Ù†Ù‰ Ù†Ù‚Ø·Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¬ÙŠÙ…: minY_scaled = s * bbox.min.y
    // ÙˆÙ†Ø±ÙØ¹/Ù†Ø®ÙØ¶ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø­ÙŠØ« ÙŠØµØ¨Ø­ Ù‚Ø§Ø¹Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© (y â‰ˆ 0.02)
    const minY = bbox.min.y;
    const groundY = 0.02;
    const pos = ent.getAttribute('position');
    pos.x = 0;
    pos.z = -2.8;                  // Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ© Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    pos.y = groundY - (s * minY);  // Ù‡Ø¨ÙˆØ· Ø¯Ù‚ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù…Ø­ÙˆØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    ent.setAttribute('position', pos);
  });

  // ØµÙ†Ø¯ÙˆÙ‚ ØªÙØ§Ø¹Ù„ÙŠ ØºÙŠØ± Ù…Ø±Ø¦ÙŠ (Ù„Ù„Ù†Ù‚Ø±/Ø§Ù„ØªØ­Ø¯ÙŠØ¯) â€” Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù€bbox Ù„Ø£Ù†Ù‡ Ø·ÙÙ„ Ù„Ù„ÙƒÙŠØ§Ù†
  const col = document.createElement('a-box');
  col.setAttribute('width','1.2');
  col.setAttribute('height','1.8');
  col.setAttribute('depth','1.2');
  col.setAttribute('opacity','0');
  col.setAttribute('position','0 0.9 0');
  col.classList.add('clickable');
  ent.appendChild(col);

  // Ø£Ø¶Ù Ù„Ù„Ù…Ø´Ù‡Ø¯ + Ø­Ø¯Ø« Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
  scene.appendChild(ent);
  placed.push({ id, name: m.name, el: ent, scored: false });

  const opt = document.createElement('option');
  opt.value = id;
  opt.textContent = m.name;
  placedList.appendChild(opt);

  selectById(id);
  msg('ØªÙ… ÙˆØ¶Ø¹ ' + m.name + ' Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ© ÙÙˆÙ‚ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ÙˆØ¨Ø­Ø¬Ù… ØµØºÙŠØ± Ù…ØªÙ†Ø§Ø³Ù‚');
  saveScene();
}





function selectById(id){
  const rec = placed.find(p=>p.id===id); if(!rec) return;
  selected = rec.el; placedList.value = id;
  evidenceSel.value = selected.getAttribute('data-valid') || 'none';
}
placedList.onchange = e => selectById(e.target.value);
scene.addEventListener('click', e => {
  const target = e.target;
  const clickedEntity = findAncestor(target, el => el.classList.contains('placed'));
  if(!clickedEntity) return;

  const rec = placed.find(p => p.el === clickedEntity);
  if(!rec || rec.scored) return;

  const val = clickedEntity.getAttribute('data-valid');
  if(val === 'true'){
    addScore(10);
    rec.scored = true;
    clickedEntity.setAttribute('data-scored','yes');
    msg('âœ… ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ù„Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­');
  } else if(val === 'false'){
    addScore(-5);
    rec.scored = true;
    clickedEntity.setAttribute('data-scored','yes');
    msg('âŒ ØªÙ… Ø®ØµÙ… Ù†Ù‚Ø·Ø© Ù„Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦');
  }
});

function findAncestor(el, pred){
  let cur = el;
  while(cur && cur !== scene){
    if(pred(cur)) return cur;
    cur = cur.parentEl;
  }
  return null;
}

/* ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§: Ø²ÙˆÙ… Ø¥Ù†/Ø£ÙˆØªØŒ ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ */
function stepVal(){ return parseFloat(document.getElementById('stepSel').value)||0.1; }
function zoomSelected(deltaZ){
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const p = selected.getAttribute('position') || {x:0,y:0,z:0};
  tweenDeltaPosition(selected, 0, 0, deltaZ, 220);
}
function rotateSelected(deltaY){
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  tweenRotationY(selected, deltaY, 220);
}
function tiltSelected(){
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const r = selected.getAttribute('rotation') || {x:0,y:0,z:0};
  tweenRotationY(selected, 0, 0); // no-op just to keep timing
  const toX = r.x + 90;
  const from = r.x;
  animate(220, p=>{
    selected.setAttribute('rotation', {x:lerp(from,toX,p), y:r.y, z:r.z});
  });
}

let moveObjInterval;

document.querySelectorAll('#controls .ctrl-btn').forEach(btn=>{
  const act = btn.dataset.act;
  const start = ()=> {
    const step = stepVal();
    if(['up','down','left','right','zoomIn','zoomOut','rotL','rotR','tilt','grow','shrink'].includes(act) && !selected){
      msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return;
    }
    moveObjInterval = setInterval(()=>{
      if(act==='up')   tweenDeltaPosition(selected, 0, +step, 0, 100);
      if(act==='down') tweenDeltaPosition(selected, 0, -step, 0, 100);
      if(act==='left') tweenDeltaPosition(selected, -step, 0, 0, 100);
      if(act==='right')tweenDeltaPosition(selected, +step, 0, 0, 100);
      if(act==='zoomIn')  zoomSelected(-step);
      if(act==='zoomOut') zoomSelected(+step);
      if(act==='rotL') rotateSelected(-10);
      if(act==='rotR') rotateSelected(+10);
      if(act==='tilt') tiltSelected();
      if(act==='grow') tweenScaleFactor(selected, 1.02, 100);
      if(act==='shrink') tweenScaleFactor(selected, 0.98, 100);
    }, 60);
  };
  const stop = ()=> clearInterval(moveObjInterval);
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchstart', e=>{ e.preventDefault(); start(); });
  btn.addEventListener('touchend', stop);
});



/* ÙƒØ§Ù…ÙŠØ±Ø§: ØªØ­Ø±ÙŠÙƒ ÙˆØ¯ÙˆØ±Ø§Ù† ØªØ¯Ø±ÙŠØ¬ÙŠ */
function moveCam(dx,dy,dz){
  const rig = document.getElementById('rig');
  const pos = rig.getAttribute('position') || {x:0,y:0,z:0};
  tweenPosition(rig, {x:pos.x+dx, y:pos.y+dy, z:pos.z+dz}, 220);
}
function yawCam(delta) {
    const rig = document.getElementById('rig');
    const rotation = rig.getAttribute('rotation');
    rig.setAttribute('rotation', {
        x: rotation.x,
        y: rotation.y + delta,
        z: rotation.z
    });
}

let moveInterval;

document.querySelectorAll('#cameraPanel .cam-btn').forEach(btn=>{
  const act = btn.dataset.cam;
  const start = ()=>{
    const step = stepVal();
    moveInterval = setInterval(()=>{
      if(act==='up')   moveCam(0, +step*3, 0);
      if(act==='down') moveCam(0, -step*3, 0);
      if(act==='left') moveCam(-step*3, 0, 0);
      if(act==='right')moveCam(+step*3, 0, 0);
      if(act==='fwd')  moveCam(0, 0, -step*3);
      if(act==='back') moveCam(0, 0, +step*3);
      if(act==='yawL') yawCam(-12);
      if(act==='yawR') yawCam(+12);
    }, 50);
  };
  const stop = ()=> clearInterval(moveInterval);
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchstart', e=>{ e.preventDefault(); start(); });
  btn.addEventListener('touchend', stop);
});



/* Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙƒÙ„ Ø¶ØºØ·Ø© */
let noteModeActive = false;
let pendingPoint = null;
const noteModal = document.getElementById('noteModal');
const noteText = document.getElementById('noteText');

document.getElementById('btnNoteMode').onclick = ()=>{
  noteModeActive=true;
  statusEl.textContent='ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØ¹Ù„';
  msg('Ø§Ø¶ØºØ· ÙÙŠ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
};

/* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© */
function createNoteAt(point, text) {
  const marker = document.createElement('a-entity');
  marker.classList.add('noteMarker','clickable');
  marker.setAttribute('position', `${point.x} ${Math.max(0.05,point.y)} ${point.z}`);
  marker.setAttribute('data-note', text || '');

  const dot = document.createElement('a-sphere');
  dot.setAttribute('radius','0.09');
  dot.setAttribute('material','color:#d4af37; emissive:#b78f2a; emissiveIntensity:0.5; metalness:0.4; roughness:0.3');
  dot.classList.add('clickable');
  marker.appendChild(dot);

  // Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
  const noteBox = document.createElement('a-entity');
  noteBox.setAttribute('visible','false');
  noteBox.setAttribute('position','0 1.0 0');

  const bg = document.createElement('a-plane');
  bg.setAttribute('width','3.2');
  bg.setAttribute('height','1.6');
  bg.setAttribute('material','color:#0a0c0f; opacity:0.88; side:double; metalness:0.2; roughness:0.4; emissive:#d4af37; emissiveIntensity:0.15');
  noteBox.appendChild(bg);

  const txt = document.createElement('a-entity');
  txt.setAttribute('text', `value:${text}; color:#fff; align:center; wrapCount:40; width:3;`);
  txt.setAttribute('position','0 0 0.02');
  noteBox.appendChild(txt);

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚
  const btnEdit = document.createElement('a-entity');
  btnEdit.setAttribute('text','value:âœï¸; color:#d4af37; align:left; width:1;');
  btnEdit.setAttribute('position','-1.3 0.6 0.02');
  btnEdit.classList.add('clickable');
  noteBox.appendChild(btnEdit);

  const btnDelete = document.createElement('a-entity');
  btnDelete.setAttribute('text','value:ğŸ—‘ï¸; color:#d4af37; align:center; width:1;');
  btnDelete.setAttribute('position','0 0.6 0.02');
  btnDelete.classList.add('clickable');
  noteBox.appendChild(btnDelete);

  const btnClose = document.createElement('a-entity');
  btnClose.setAttribute('text','value:âœ–ï¸; color:#d4af37; align:right; width:1;');
  btnClose.setAttribute('position','1.3 0.6 0.02');
  btnClose.classList.add('clickable');
  noteBox.appendChild(btnClose);

  marker.appendChild(noteBox);
  marker._label = noteBox;
  marker._text = txt;

  // Ø§Ù„ØªÙØ§Ø¹Ù„
  dot.addEventListener('click', e => { e.stopPropagation(); toggleNote(); });
  btnClose.addEventListener('click', e => { e.stopPropagation(); noteBox.setAttribute('visible','false'); });
  btnDelete.addEventListener('click', e => {
    e.stopPropagation();
    marker.remove();
    saveNotes();
  });
  btnEdit.addEventListener('click', e => {
    e.stopPropagation();
    const newText = prompt('ğŸ“ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:', marker.getAttribute('data-note') || '');
    if(newText !== null){
      marker.setAttribute('data-note', newText);
      txt.setAttribute('text', `value:${newText}; color:#fff; align:center; wrapCount:40; width:3;`);
      saveNotes();
    }
  });

  function toggleNote(){ const vis = noteBox.getAttribute('visible'); noteBox.setAttribute('visible', !vis); }

  scene.appendChild(marker);
  return marker;
}

/* Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Local Storage */
function saveNotes(){
  const notes = [];
  document.querySelectorAll('.noteMarker').forEach(p=>{
    notes.push({
      position: p.getAttribute('position'),
      text: p.getAttribute('data-note') || ''
    });
  });
  localStorage.setItem('crimeNotes', JSON.stringify(notes));
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© */
window.addEventListener('load', ()=>{
  const savedNotes = localStorage.getItem('crimeNotes');
  if(savedNotes){
    const notes = JSON.parse(savedNotes);
    notes.forEach(n=>{
      createNoteAt(n.position, n.text);
    });
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
  }
});

/* Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
function deleteNotes(){
  document.querySelectorAll('.noteMarker').forEach(n=>n.remove());
  localStorage.removeItem('crimeNotes');
  msg('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
}

/* Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© */
document.getElementById('noteSave').onclick = ()=>{
  const t = noteText.value.trim();
  if(!pendingPoint){ noteModal.style.display='none'; return; }
  const marker = createNoteAt(pendingPoint, t);
  marker._label.setAttribute('visible','true');
  pendingPoint=null; noteModal.style.display='none';
  noteModeActive=false; statusEl.textContent='Ø¬Ø§Ù‡Ø²';
  saveNotes(); // âœ… Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
};

document.getElementById('noteCancel').onclick = ()=>{
  pendingPoint=null;
  noteModal.style.display='none';
  statusEl.textContent='Ø¬Ø§Ù‡Ø²';
  noteModeActive=false;
};

// Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù†Ù‚Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
ray.addEventListener('click', ev => {
  if (!noteModeActive) return; // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØ¹Ù‘Ù„ØŒ Ù„Ø§ ØªØ¹Ù…Ù„ Ø´ÙŠØ¡
  const point = ev.detail?.intersection?.point;
  if (!point) return;

  // Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
  pendingPoint = point;

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ
  noteModal.style.display = 'grid';
  noteText.value = '';
  noteText.focus();
});


/* Ø§Ù„Ù…Ø¤Ù‚Øª + Ø§Ù„Ù†Ù‚Ø§Ø· (ÙƒÙ…Ø§ Ù‡ÙŠ) */
let timeLeft=0, timer=null, score=0;
function fmt(t){ const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
function endTimer(resetOnly=false){ if(timer){ clearInterval(timer); timer=null; } if(resetOnly){ timeLeft=0; timeEl.textContent='--:--'; statusEl.textContent='Ø¬Ø§Ù‡Ø²'; return; } statusEl.textContent='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª'; }
function animateNumber(el, from, to, dur=350){ const start=performance.now(); function step(now){ const p=Math.min(1,(now-start)/dur); const val = Math.round(from + (to-from)*p); el.textContent = String(val); if(p<1) requestAnimationFrame(step); } requestAnimationFrame(step); }
function addScore(delta){ const prev=score; score = Math.max(0, score + delta); animateNumber(scoreEl, prev, score); }
const durInp = document.getElementById('duration');
document.getElementById('btnGameStart').onclick = ()=>{
  timeLeft = parseInt(durInp.value)||120;
  if(timer) clearInterval(timer);
  timeEl.textContent = fmt(timeLeft);
  statusEl.textContent='Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
  placed.forEach(p=>{ if(p.el) p.el.setAttribute('data-scored','no'); });
  timer = setInterval(()=>{ timeLeft--; timeEl.textContent=fmt(timeLeft); if(timeLeft<=0){ endTimer(); msg('â±ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª'); } },1000);
};
document.getElementById('btnGameStop').onclick = ()=>{ endTimer(); msg('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'); };
document.getElementById('btnGameFinalize').onclick = ()=>{ msg(`ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ â€” Ù†Ù‚Ø§Ø·Ùƒ: ${score}`); };

function flashHalo(ent, color){
  const halo = document.createElement('a-ring');
  halo.setAttribute('radius-inner','0.5'); halo.setAttribute('radius-outer','0.6'); halo.setAttribute('rotation','-90 0 0');
  halo.setAttribute('material',`color:${color}; opacity:0.9; transparent:true`);
  ent.appendChild(halo);
  setTimeout(()=>{ try{ ent.removeChild(halo);}catch(e){} }, 350);
}

/* ========================
   ğŸ¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ù… (Ø¥ØµÙ„Ø§Ø­ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·)
   ======================== */
ray.addEventListener('click',(ev)=>{
  const el = ev.detail?.intersectedEl;
  if(!el) return;

  // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡
  const ent = findAncestor(el, e => e.classList && e.classList.contains('placed'));
  if(ent){
    const rec = placed.find(p => p.el === ent || p.id === ent.id);
    if(rec) selectById(rec.id);
  }

  // âœ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  handleNoteClick(ev);

  // âœ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø³ÙˆØ§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø£Ùˆ Ø¨Ø¯ÙˆÙ†Ù‡
  const target = findAncestor(el, e => e.classList && e.classList.contains('placed'));
  if(target){
    const valid = target.getAttribute('data-valid');
    const scored = target.getAttribute('data-scored');

    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù†ØµØ±
    if(scored === 'yes') return;

    if(valid === 'true'){ 
      addScore(10); 
      flashHalo(target, '#39d98a'); 
      target.setAttribute('data-scored', 'yes'); 
    }
    else if(valid === 'false'){ 
      addScore(-5); 
      flashHalo(target, '#ff5c5c'); 
      target.setAttribute('data-scored', 'yes'); 
    }
  }
});

/* Ø­Ø°Ù ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø£ÙƒØ«Ø± Ø«Ø¨Ø§ØªÙ‹Ø§ */
document.getElementById('btnDelete').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const id = placedList.value;
  try{ selected.parentNode && selected.parentNode.removeChild(selected); }catch(e){}
  placed = placed.filter(p=>p.id!==id);
  [...placedList.options].forEach(o=>{ if(o.value===id) o.remove(); });
  selected=null; evidenceSel.value='none';
  msg('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±');
  saveScene(); // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
};


document.getElementById('btnReset').onclick = ()=>{
  placed.forEach(p=>{ try{ p.el.parentNode && p.el.parentNode.removeChild(p.el); }catch(e){} });
  placed=[]; placedList.innerHTML='';
  document.querySelectorAll('.noteMarker').forEach(n=>{ try{ n.parentNode && n.parentNode.removeChild(n); }catch(e){} });
  selected=null; evidenceSel.value='none';
  endTimer(true);
  score = 0; scoreEl.textContent='0'; statusEl.textContent='ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·';
  msg('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯');
};
document.getElementById('btnApplyEvidence').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }

  const val = evidenceSel.value;
  selected.setAttribute('data-valid', val);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  [...selected.children].filter(c=> c.classList && c.classList.contains('evidenceHalo')).forEach(h=>selected.removeChild(h));

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  if(val==='true' || val==='false'){
    const halo = document.createElement('a-torus');
    halo.classList.add('evidenceHalo');
    halo.setAttribute('radius','0.6'); halo.setAttribute('radius-tubular','0.02');
    halo.setAttribute('rotation','90 0 0'); halo.setAttribute('position','0 0.05 0');
    const col = (val==='true') ? '#39d98a' : '#ff5c5c';
    halo.setAttribute('material',`color:${col}; emissive:${col}; emissiveIntensity:0.5; opacity:0.85; transparent:true`);
    selected.appendChild(halo);
  }


  msg('âœ… ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù†ØµØ±');
  saveScene();
};
// Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ù‡Ø¯ ÙÙŠ Local Storage
function saveScene() {
  const sceneData = [];
  document.querySelectorAll('a-entity[gltf-model]').forEach(ent => {
    sceneData.push({
      model: ent.getAttribute('gltf-model'),
      position: ent.getAttribute('position'),
      rotation: ent.getAttribute('rotation'),
      scale: ent.getAttribute('scale')
    });
  });
  localStorage.setItem('crimeSceneData', JSON.stringify(sceneData));
  console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ù‡Ø¯ âœ…");
}

/* ========================
   âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù…Ù† Local Storage
   ======================== */
/* ========================
   âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù…Ù† Local Storage Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙƒØ§Ù…Ù„
   ======================== */
window.addEventListener('load', () => {
  const saved = localStorage.getItem('crimeSceneData');
  if (saved) {
    const sceneData = JSON.parse(saved);
    const scene = document.querySelector('a-scene');
    const placedList = document.getElementById('placedList');

    sceneData.forEach((item, idx) => {
      const id = 'ent-' + Date.now() + '-' + idx;
      const ent = document.createElement('a-entity');
      ent.setAttribute('id', id);
      ent.setAttribute('gltf-model', item.model);
      ent.setAttribute('position', item.position);
      ent.setAttribute('rotation', item.rotation);
      ent.setAttribute('scale', item.scale);
      ent.classList.add('placed', 'clickable');
      ent.setAttribute('data-valid', 'none');
      ent.setAttribute('data-scored', 'no');
      scene.appendChild(ent);

      // Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
      const name = item.model.split('/').pop();
      placed.push({ id, name, el: ent, scored: false });

      // Ø£Ø¶Ù Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = name;
      placedList.appendChild(opt);

      // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      ent.addEventListener('click', () => {
        selectById(id);
      });
    });

    // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    placedList.onchange = e => selectById(e.target.value);

    msg("âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ØªØ§Ø­");
    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù…Ù† Local Storage Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙƒØ§Ù…Ù„");
    saveScene(); // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
  }
});

/* ========================
   âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ù‡Ø¯ ÙÙŠ Local Storage
   ======================== */
function saveScene() {
  const data = [];
  document.querySelectorAll('.placed').forEach(ent => {
    data.push({
      model: ent.getAttribute('gltf-model'),
      position: ent.getAttribute('position'),
      rotation: ent.getAttribute('rotation'),
      scale: ent.getAttribute('scale')
    });
  });
  localStorage.setItem('crimeSceneData', JSON.stringify(data));
  console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
}

/* ========================
   ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ±
   ======================== */
document.getElementById('btnDelete').onclick = ()=>{
  if(!selected){ msg('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const id = placedList.value;
  try{ selected.parentNode && selected.parentNode.removeChild(selected); }catch(e){}
  placed = placed.filter(p=>p.id!==id);
  [...placedList.options].forEach(o=>{ if(o.value===id) o.remove(); });
  selected=null; evidenceSel.value='none';
  msg('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±');
  saveScene(); // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
};

/* ========================
   ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯
   ======================== */
document.getElementById('btnReset').onclick = ()=>{
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŸ')) return;
  document.querySelectorAll('.placed').forEach(el=>el.remove());
  placed = [];
  placedList.innerHTML='';
  localStorage.removeItem('crimeSceneData');
  localStorage.removeItem('crimeNotes');
  msg('ğŸ§¹ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
  saveScene(); // âœ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ©
};

/* ========================
   ğŸ•’ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
   ======================== */
// Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø£Ùˆ ØªØ¯ÙˆÙŠØ± Ø£Ùˆ ØªÙƒØ¨ÙŠØ± Ø£ÙŠ Ø¹Ù†ØµØ±
document.addEventListener('mouseup', ()=>{
  if(selected) saveScene();
});
document.addEventListener('touchend', ()=>{
  if(selected) saveScene();
});



</script>
</body>
</html>
